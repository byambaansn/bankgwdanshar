<?php

/**
 * BankCandyTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BankCandyTable extends Doctrine_Table
{

    const STAT_NEW = 1;
    const STAT_PROCESS = 2;
    const STAT_SUCCESS = 3;
    const STAT_FAILED_CHARGE = 4;
    const STAT_FAILED_OUTCOME = 5;
    const STAT_FAILED_DEALER = 6;
    const STAT_FAILED = 7;
    const STAT_FAILED_MAX_AMOUNT = 8;
    const STAT_FAILED_DUPLICATE_AMOUNT = 9;
    const STAT_FAILED_MIN_AMOUNT = 10;
    const STAT_WAIT_TEMP = 11;
    const STAT_BLOCK_DEALER = 12;
    const STAT_TRANS_VALUE_WRONG = 13;
    const MAX_TRY_COUNT = 3;
    const MAX_AMOUNT_LIMIT = 99999999;
    const MIN_AMOUNT_LIMIT = 0;

    /**
     * Returns an instance of this class.
     *
     * @return object BankCandyTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('BankCandy');
    }

    public static function getByOrderId($orderId)
    {
        $sql = "SELECT * 
                FROM bankgw.bank_candy
                WHERE order_id = $orderId";
        $pdo = Doctrine_Manager::connection()->getDbh();
        return $pdo->query($sql)->fetch();
    }

    /**
     * 
     * @param int $id
     * @param int $status
     * @return BankCandy
     */
    public static function retrieveByPK($id, $status = 0)
    {
        $q = Doctrine_Query::create()
                ->from('BankCandy')
                ->where('id = ?', $id);

        if ($status) {
            $q->andWhere('status = ?', $status);
        }

        return $q->fetchOne();
    }

    /**
     *
     * @param int $orderId
     * @param int $bankId
     * @return BankCandy
     */
    public static function findOneByOrderId($orderId, $bankId = BankTable::CANDY)
    {
        $q = Doctrine_Query::create()
                ->from('BankCandy')
                ->where('order_id = ?', $orderId)
                ->addWhere('vendor_id = ?', $bankId);

        return $q->fetchOne();
    }

    /**
     * Дахин цэнэглэлт
     *
     * @param null $bankCandy
     * @param $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function recharge($bankCandy = null, $limit = 50)
    {
        if ($bankCandy instanceof BankCandy) {
            if ($bankCandy->canReCharge()) {
                $bankCandy->status = self::STAT_PROCESS;
                $bankCandy->save();
            }
            $bankCandyRows = array($bankCandy);
        } elseif ($bankCandy) {
            return FALSE;
        } else {
            $bankCandyRows = self::updateForCharge('ADD', $limit);
        }

        foreach ($bankCandyRows as $bankCandy) {
            try {
                if (in_array($bankCandy->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankCandy->status = self::STAT_PROCESS;
                    $bankCandy->save();
                }
                if ($bankCandy->status == self::STAT_PROCESS) {
                    $bankCandy->try_count++;
                    $bankCandy->save();

                    $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/dealer/process-' . date("Ymd") . '.log'));
                    $dealerAgent = DealerGateway::findDealerByMobile($bankCandy->charge_mobile, $logger);

                    if (!$dealerAgent) {
                        $dealer = DealerCharge::getDealer($bankCandy->charge_mobile);
                        if ($dealer) {
                            # If the charge amount exceeds the max amount limit
                            if ($bankCandy->order_amount > self::MAX_AMOUNT_LIMIT) {
                                $bankCandy->status = self::STAT_FAILED_MAX_AMOUNT;
                                $bankCandy->save();
                                continue;
                            } elseif ($bankCandy->order_amount < self::MIN_AMOUNT_LIMIT) {
                                $bankCandy->status = self::STAT_FAILED_MIN_AMOUNT;
                                $bankCandy->save();
                                continue;
                            }
                        } else {
                            $bankCandy->status = self::STAT_FAILED_DEALER;
                            $bankCandy->save();
                            continue;
                        }
                    }

                    $logId = LogTools::setLogCandyCharge($bankCandy->id);
                    $orderMobile = null;
                    $time = -time();
                    # Цэнэглэлт хийх
                    if ($dealerAgent) {
                        $chargeResult = DealerGateway::charge($dealerAgent['dealerId'], $bankCandy->order_amount, 'CANDY', $logger);
                        $orderMobile = $dealerAgent['dealerCode'];
                    } else {
                        $chargeResult = DealerCharge::chargeByCandy($bankCandy->charge_mobile, $bankCandy->order_amount);
                    }
                    $time += time();

                    LogTools::updateLogCandyCharge($logId, $chargeResult['log_request'], $chargeResult['log_response'], $time);

                    if ($chargeResult['success'] == TRUE) {
                        # Цэнэглэгдсэн мөнгөн дүн болон хувийг хадгалах
                        $bankCandy->charge_amount = $chargeResult['transferred'];
                        $bankCandy->percent = $chargeResult['percent'];
                        if ($orderMobile) {
                            $bankCandy->order_mobile = $orderMobile;
                        }
                        $bankCandy->save();
                        $pdo = Doctrine_Manager::connection()->getDbh();
                        $sql = "UPDATE bankgw.bank_candy
                                        SET status = '" . self::STAT_SUCCESS . "'
                                        WHERE id = '" . $bankCandy['id'] . "'
                                        AND status = '" . self::STAT_PROCESS . "'
                                        LIMIT 1";
                        $affectedRows = $pdo->exec($sql);
                        if ($chargeNumber !== $bankCandy->charge_mobile) {
                            $bankCandy->charge_mobile = $chargeNumber;
                            $bankCandy->save();
                            # Header
                            DealerCharge::sentMessage($chargeNumber, "HEAD dealer message");
                            # Child
                            DealerCharge::sentMessage($bankCandy->order_mobile, "CHILD dealer message");
                        }
                    } else {
                        if ($chargeResult['error_code'] == self::STAT_FAILED_MAX_AMOUNT) {
                            $bankCandy->status = self::STAT_FAILED_MAX_AMOUNT;
                        } elseif ($chargeResult['error_code'] == self::STAT_FAILED_MIN_AMOUNT) {
                            $bankCandy->status = self::STAT_FAILED_MIN_AMOUNT;
                        } else {
                            $bankCandy->status = self::STAT_FAILED_CHARGE;
                        }
                        $bankCandy->save();

                        //
                        continue;
                    }
                } else {
                    if ($bankCandy->canReCharge() && $bankCandy->try_count < self::MAX_TRY_COUNT) {
                        $bankCandy->status = self::STAT_NEW;
                        $bankCandy->save();
                    }
                    //used to log here...
                }
            } catch (\Exception $ex) {
                $bankCandy->status = self::STAT_FAILED;
                $bankCandy->save();
            }
        }

        return TRUE;
    }

    /**
     * Цэнэглэх хуулгууд
     * @param $type
     * @param int $limit
     * @return Doctrine_Collection
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function updateForCharge($type, $limit)
    {
        $pdo = Doctrine_Manager::connection()->getDbh();
        // FOR UPDATE ажиллахын тулд AUTO COMMIT идэвхгүй байх ёстой
        $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 0);
        $pdo->beginTransaction();
        // Шинэ гүйлгээнүүдийн ID-г авч FOR UPDATE-р түгжинэ
        $ids = Doctrine_Query::create()
            ->select('id')
            ->from('BankCandy')
            ->whereIn('status', array(self::STAT_NEW))
            ->andWhere('order_type = ?', $type)
            ->limit($limit)
            ->forUpdate(true)
            ->execute(array(), Doctrine_Core::HYDRATE_SINGLE_SCALAR);
        // Олдсон ID-нуудтай гүйлгээнүүдийн төлвийг PROCESS болгоно
        if ($ids) {
            Doctrine_Query::create()
                ->update('BankCandy')
                ->set('status', self::STAT_PROCESS)
                ->whereIn('id', $ids)
                ->execute();
            $pdo->commit();
            $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 1);
            // Төлөв нь шинэчлэгдсэн гүйлгээнүүдээ буцаах
            $qSelect = Doctrine_Query::create()
                ->from('BankCandy')
                ->whereIn('id', $ids);
            return $qSelect->execute();
        } else {
            $pdo->commit();
            $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 1);
            return null;
        }
    }

    /**
     *
     * @param bool $excel
     * @return \sfDoctrinePager
     * @throws Doctrine_Query_Exception
     * @throws sfException
     */
    public static function getList($excel = false)
    {
        $q = Doctrine_Query::create()
                ->from('BankCandy')
                ->where('vendor_id = ?', VendorTable::CANDY)
                ->orderBy('status DESC, id DESC');

        $request = sfContext::getInstance()->getRequest();

        // mandatory
        $dateFrom = $request->getParameter('dateFrom') ? $request->getParameter('dateFrom') : date('Y-m-d');
        $dateTo = $request->getParameter('dateTo') ? $request->getParameter('dateTo') : date('Y-m-d');
        $q->addWhere("created_at >= ?", $dateFrom . " 00:00:00");
        $q->addWhere("created_at <= ?", $dateTo . " 23:59:59");

        // optional
        $chargedMobile = (int) $request->getParameter('chargedMobile');
        if ($chargedMobile) {
            $q->addWhere('charge_mobile = ?', $chargedMobile);
        }

        // optional
        $orderedMobile = (int) $request->getParameter('orderedMobile');
        if ($orderedMobile) {
            $q->addWhere('order_mobile = ?', $orderedMobile);
        }

        // optional
        $orderId = $request->getParameter('orderId');
        if ($orderId) {
            $q->addWhere('order_id = ?', $orderId);
        }

        // optional
        $status = (int) $request->getParameter('status');
        if ($status) {
            $q->addWhere('status = ?', $status);
        }
        if ($excel) {
            return $q->execute();
        }

        // pager
        $page = (int) $request->getParameter('page', 1);

        $pager = new sfDoctrinePager('BankCandy', 100);
        $pager->setQuery($q);
        $pager->setPage($page);
        $pager->init();

        return $pager;
    }

    /**
     * Төлөв
     * 
     * @return array
     */
    public static function getForSelectStatus()
    {
        $status = array(
            self::STAT_NEW => 'Шинэ хуулга',
            self::STAT_PROCESS => 'Цэнэглэж байна',
            self::STAT_SUCCESS => 'Амжилттай цэнэглэсэн',
            self::STAT_FAILED_CHARGE => 'Цэнэглэлт хийгдсэнгүй',
            self::STAT_FAILED_OUTCOME => 'Зарлага хийгдсэнгүй',
            self::STAT_FAILED_DEALER => 'Гэрээт олдсонгүй',
            self::STAT_FAILED => 'Алдаа гарсан',
            self::STAT_FAILED_MAX_AMOUNT => 'Их хэмжээний дүнтэй',
            self::STAT_FAILED_DUPLICATE_AMOUNT => 'Ижил хэмжээний үнийн дүнтэй цэнэглэлт/баталгаажуулах/',
            self::STAT_FAILED_MIN_AMOUNT => 'Цэнэглэх доод хязгаараас бага дүнтэй',
        );
        return $status;
    }

    /**
     * Төлвийн нэр
     *
     * @param int $v
     * @param int $type
     * @param boolean $img
     * @return string
     */
    public static function getStatusName($v, $type = 1, $img = false)
    {
        $v = (int) $v;

        $arr = self::getForSelectStatus($type);

        if (!isset($arr[$v])) {
            return '#';
        }

        if (!$img) {
            return $arr[$v];
        }

        $attr = 'title="' . $arr[$v] . '" alt="' . $arr[$v] . '"';

        switch ($v) {
            case self::STAT_NEW:
                return '<img src="/images/icons/info.png" ' . $attr . ' />';
            case self::STAT_PROCESS:
                return '<img src="/images/icons/process.png" ' . $attr . ' />';
            case self::STAT_FAILED_OUTCOME:
                return '<img src="/images/icons/warning.png" ' . $attr . ' />';
            case self::STAT_SUCCESS:
                return '<img src="/images/icons/save.png" ' . $attr . ' />';
            case self::STAT_FAILED_CHARGE:
                return '<img src="/images/icons/error.png" ' . $attr . ' />';
            case self::STAT_FAILED_DEALER:
                return '<img src="/images/icons/user_delete.png" ' . $attr . ' />';
            case self::STAT_FAILED:
                return '<img src="/images/icons/error.png" ' . $attr . ' />';
            case self::STAT_FAILED_MAX_AMOUNT:
                return '<img src="/images/icons/world.png" ' . $attr . ' />';
            case self::STAT_FAILED_MIN_AMOUNT:
                return '<img src="/images/icons/world.png" ' . $attr . ' />';
            case self::STAT_WAIT_TEMP:
                return '<img src="/images/icons/wait.png" ' . $attr . ' />';
            case self::STAT_BLOCK_DEALER:
                return '<img src="/images/icons/wait.png" ' . $attr . ' />';
            case self::STAT_TRANS_VALUE_WRONG:
                return '<img src="/images/icons/error.png" ' . $attr . ' />';
            default :
                return '#';
        }
    }

    /**
     * Дахин зарлага хийх /борлуулалтын бүртгэл/
     *
     * @param BankKhaan $bankObject
     * @param array $dealer (code => string, alias => string, mobile => int, user_id => int, sale_percent_mtopup => int)
     * @param date $date
     * @param null $dealerAgent
     * @param int $percent
     * @return boolean
     */
    public static function reoutcome($bankObject, $dealer, $date = null, $dealerAgent = null, $percent = 0)
    {
        if (!($bankObject instanceof BankCandy)) {
            return FALSE;
        } elseif ($bankObject->status == self::STAT_SUCCESS) {
            return FALSE;
        }

        if (!sizeof($dealer) && !sizeof($dealerAgent)) {
            return FALSE;
        }

        if (!$percent) {
            $percent = $bankObject->percent;
        }
        if ($dealerAgent) {
            $outcomeUserId = BaseSms::DEALER_SYSTEM;
            $dealerCode = $dealerAgent['dealerCode'];
            $dealerAlias = $dealerAgent['locationDesc'];
            $dealerMobile = $bankObject->charge_mobile;
        } else {
            $outcomeUserId = $dealer['user_id'];
            $dealerCode = $dealer['code'];
            $dealerMobile = $dealer['mobile'];
            $dealerAlias = $dealer['alias'];
        }

        $params = array(
            'vendor' => VendorTable::CANDY,
            'outcomeDate' => $date,
            'percent' => $percent,
            'productPrice' => 1,
            'totalPrice' => $bankObject->order_amount,
            'paid' => $bankObject->order_amount,
            'customerName' => $dealerCode . ' ' . $dealerAlias,
            'customerPhone' => $dealerMobile,
            'outcomeUserId' => $outcomeUserId,
            'quantity' => $bankObject->charge_amount,
            'vaucher' => $bankObject->order_id,
            'comment' => $bankObject->order_p,
            'discount' => $bankObject->percent,
            'relationId' => $bankObject->id,
        );
        LogTools::setSmsOutcomeParam(print_r($params, TRUE));
        return BaseSms::insertOutcomeAPI($params);
    }

}
