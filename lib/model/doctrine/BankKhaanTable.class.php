<?php

/**
 * BankKhaanTable.
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class BankKhaanTable extends Doctrine_Table
{

    const STAT_NEW = 1;
    const STAT_PROCESS = 2;
    const STAT_SUCCESS = 3;
    const STAT_FAILED_CHARGE = 4;
    const STAT_FAILED_OUTCOME = 5;
    const STAT_FAILED_DEALER = 6;
    const STAT_FAILED = 7;
    const STAT_FAILED_MAX_AMOUNT = 8;
    const STAT_FAILED_DUPLICATE_AMOUNT = 9;
    const STAT_FAILED_MIN_AMOUNT = 10;
    const STAT_CORRECTION = 11; // банкны залруулга
    const STAT_CORRECTION_SUCCESS = 12; // банкны залруулга амжилттай
    const STAT_CORRECTION_FAILED = 13; // банкны залруулга амжилтгүй
    const STAT_BANKPAYMENT_AMOUNT = 14; // Гэрээний үлдэгдэлээс зөрүүтэй 3000
    #
    const MAX_TRY_COUNT = 3;
    const MAX_AMOUNT_LIMIT = 99999999;
    const MIN_AMOUNT_LIMIT = 28800;
    # KHAAN
    const KHAAN_URL = 'https://10.99.9.139/WCF_Statement/Service.svc?wsdl';
    #type
    CONST TYPE_DEALER = 1;
    CONST TYPE_CALLPAYMENT = 2;

    /**
     * Returns an instance of this class.
     *
     * @return object BankKhaanTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('BankKhaan');
    }

    /**
     * 
     * @param int $id
     * @param int $status
     * @return BankKhaan
     */
    public static function retrieveByPK($id, $status = 0)
    {
        $q = Doctrine_Query::create()
                ->from('BankKhaan')
                ->where('id = ?', $id);

        if ($status) {
            $q->andWhere('status = ?', $status);
        }

        return $q->fetchOne();
    }

    public static function retrieveByTran($order_id, $order_type, $order_amount, $order_date)
    {
        $q = Doctrine_Query::create()
                ->from('BankKhaan')
                ->where('order_id = ?', $order_id)
                ->addWhere('order_type = ?', $order_type)
                ->addWhere('order_amount = ?', $order_amount)
                ->addWhere('order_date = ?', $order_date);

        return $q->fetchOne();
    }

    /**
     * 
     * @param int $orderId
     * @return BankKhaan
     */
    public static function findOneByOrderId($orderId)
    {
        $q = Doctrine_Query::create()
                ->from('BankKhaan')
                ->where('order_id = ?', $orderId)
                ->addWhere('vendor_id = ?', VendorTable::BANK_KHAAN)
                ->addWhere('created_at > ?', date('Y-m-d'))
                ->addWhere("DATE_FORMAT(order_date, '%Y-%m-%d') = ?", date('Y-m-d'));
//         DATE_FORMAT(o.outcome_date, '%Y-%m-%d')
        return $q->fetchOne();
    }

    /**
     * залруулга олох
     * @param int $number , amount
     * @param $amount
     * @return BankKhaan
     */
    public static function findOneByNumberAndAmount($number, $amount)
    {
        $q = Doctrine_Query::create()
                ->from('BankKhaan')
                ->where('order_id = ?', $number)
                ->addWhere('status = ?', self::STAT_NEW)
                ->addWhere('vendor_id = ?', $amount);
        return $q->fetchOne();
    }

    /**
     * залруулга төлөвт оруулах
     * @param int $number , amount
     * @param int $amount
     * @param string $bank_account
     * @return Doctrine_Collection
     * @throws Doctrine_Query_Exception
     */
    public static function updateTransByCorrection($number = 0, $amount = 0, $bank_account = '')
    {
        if ($number === '') {
            $number = 0;
        }
        $q = Doctrine_Query::create()
                ->update('BankKhaan')
                ->set('status', '?', self::STAT_CORRECTION)
                ->where('charge_mobile = ?', $number)
                ->addWhere('status = ?', self::STAT_NEW)
                ->addWhere('bank_account = ?', $bank_account)
              
                ->addWhere('order_amount = ?', $amount);
        return $q->execute();
    }

    /**
     *
     * @param $account
     * @param bool $excel
     * @return \sfDoctrinePager
     * @throws Doctrine_Query_Exception
     * @throws sfException
     */
    public static function getList($account, $excel = false)
    {
        $q = Doctrine_Query::create()
                ->from('BankKhaan');
        if (is_array($account)) {
            $q->whereIn('bank_account', $account);
        } else {
            $q->where('bank_account = ?', $account);
        }
        $q->addWhere('vendor_id = ?', VendorTable::BANK_KHAAN)
                ->orderBy('status DESC, id DESC');
        $request = sfContext::getInstance()->getRequest();

        $orderedMobile = (int) $request->getParameter('orderedMobile');
        if ($orderedMobile) {
            $q->addWhere('order_mobile = ?', $orderedMobile);
        }
         // optional
         $relatedAccount = (int) $request->getParameter('relatedAccount');
         if ($relatedAccount) {
             $q->addWhere('related_account = ?', $relatedAccount);
         }

        // mandatory
        $dateFrom = $request->getParameter('dateFrom') ? $request->getParameter('dateFrom') : date('Y-m-d');
        $dateTo = $request->getParameter('dateTo') ? $request->getParameter('dateTo') : date('Y-m-d');
        $q->addWhere("created_at >= ?", $dateFrom . " 00:00:00");
        $q->addWhere("created_at <= ?", $dateTo . " 23:59:59");

        // optional
        $chargedMobile = (int) $request->getParameter('chargedMobile');
        if ($chargedMobile) {
            $q->addWhere('charge_mobile = ?', $chargedMobile);
        }

        // optional
        $orderedMobile = (int) $request->getParameter('orderedMobile');
        if ($orderedMobile) {
            $q->addWhere('order_mobile = ?', $orderedMobile);
        }

        // optional
        $orderId = $request->getParameter('orderId');
        if ($orderId) {
            $q->addWhere('order_id = ?', $orderId);
        }

        // optional
        $status = (int) $request->getParameter('status');
        if ($status) {
            $q->addWhere('status = ?', $status);
        }
        if ($excel) {
            return $q->execute();
        }

        // pager
        $page = (int) $request->getParameter('page', 1);

        $pager = new sfDoctrinePager('BankKhaan', 100);
        $pager->setQuery($q);
        $pager->setPage($page);
        $pager->init();

        return $pager;
    }

    /**
     *
     * @param $account
     * @param bool $excel
     * @return array
     * @throws Doctrine_Manager_Exception
     * @throws sfException
     */
    public static function getListCustom($account, $excel = false)
    {
        $pdo = Doctrine_Manager::connection()->getDbh();

        $where = array();
        $request = sfContext::getInstance()->getRequest();

        // mandatory
        $dateFrom = $request->getParameter('dateFrom') ? $request->getParameter('dateFrom') : date('Y-m-d');
        $dateTo = $request->getParameter('dateTo') ? $request->getParameter('dateTo') : date('Y-m-d');

        $where[] = "b.created_at >='$dateFrom 00:00:00'";
        $where[] = "b.created_at <='$dateTo 23:59:59'";

        $where[] = "vendor_id=" . VendorTable::BANK_KHAAN;

        if (is_array($account)) {
            $where[] = "b.bank_account IN (" . implode(',', $account) . ")";
        } else {
            $where[] = "b.bank_account ='$account'";
        }

        // optional
        $relatedAccount = (int) $request->getParameter('relatedAccount');
        if ($relatedAccount) {
            $where[] = "b.related_account ='$relatedAccount'";
        }

        // optional
        $chargedMobile = (int) $request->getParameter('chargedMobile');
        if ($chargedMobile) {
            $where[] = "b.charge_mobile ='$chargedMobile'";
        }

        // optional
        $orderedMobile = (int) $request->getParameter('orderedMobile');
        if ($orderedMobile) {
            $where[] = "b.order_mobile ='$orderedMobile'";
        }

        // optional
        $orderId = $request->getParameter('orderId');
        if ($orderId) {
            $where[] = "b.order_id ='$orderId'";
        }

        // optional
        $status = (int) $request->getParameter('status');
        if ($status) {
            $where[] = "b.status ='$status'";
        }
        $where = implode(' AND ', $where);

        $query = "
            SELECT b.*
            FROM bankgw.bank_khaan force index (createdat) as b
            WHERE $where
            ORDER BY b.status DESC, b.id DESC";

        $rows = $pdo->query($query)->fetchAll(PDO::FETCH_ASSOC);

        return $rows;
    }

    /**
     * Төлөв
     *
     * @param $type
     * @return array
     */
    public static function getForSelectStatus($type)
    {
        switch ($type) {
            case self::TYPE_DEALER:
                $status = array(
                    self::STAT_NEW => 'Шинэ хуулга',
                    self::STAT_PROCESS => 'Цэнэглэж байна',
                    self::STAT_SUCCESS => 'Амжилттай цэнэглэсэн',
                    self::STAT_FAILED_CHARGE => 'Цэнэглэлт хийгдсэнгүй',
                    self::STAT_FAILED_OUTCOME => 'Зарлага хийгдсэнгүй',
                    self::STAT_FAILED_DEALER => 'Гэрээт олдсонгүй',
                    self::STAT_FAILED => 'Алдаа гарсан',
                    self::STAT_FAILED_MAX_AMOUNT => 'Их хэмжээний дүнтэй',
                    self::STAT_FAILED_DUPLICATE_AMOUNT => 'Ижил хэмжээний үнийн дүнтэй цэнэглэлт/баталгаажуулах/',
                    self::STAT_FAILED_MIN_AMOUNT => 'Цэнэглэх доод хязгаараас бага дүнтэй',
                    self::STAT_CORRECTION => 'Банкны залруулга',
                    self::STAT_CORRECTION_SUCCESS => 'Банкны залруулга амжилттай',
                    self::STAT_CORRECTION_SUCCESS => 'Банкны залруулга амжилтгүй',
                );
                break;
            case self::TYPE_CALLPAYMENT:
                $status = array(
                    self::STAT_NEW => 'Шинэ хуулга',
                    self::STAT_PROCESS => 'Төлөлт оруулж байна',
                    self::STAT_SUCCESS => 'Амжилттай төлөлт оруулсан',
                    self::STAT_FAILED_CHARGE => 'Төлөлт оруулсангүй',
                    self::STAT_FAILED => 'Алдаа гарсан',
                );
                break;
        }
        return $status;
    }

    /**
     * Төлвийн нэр
     *
     * @param int $v
     * @param $type
     * @param boolean $img
     * @return string
     */
    public static function getStatusName($v, $type, $img = false)
    {
        $v = (int) $v;

        $arr = self::getForSelectStatus($type);

        if (!isset($arr[$v])) {
            return '#';
        }

        if (!$img) {
            return $arr[$v];
        }

        $attr = 'title="' . $arr[$v] . '" alt="' . $arr[$v] . '"';

        switch ($v) {
            case self::STAT_NEW:
                return '<img src="/images/icons/info.png" ' . $attr . ' />';
            case self::STAT_PROCESS:
                return '<img src="/images/icons/process.png" ' . $attr . ' />';
            case self::STAT_FAILED_OUTCOME:
                return '<img src="/images/icons/warning.png" ' . $attr . ' />';
            case self::STAT_SUCCESS:
                return '<img src="/images/icons/save.png" ' . $attr . ' />';
            case self::STAT_FAILED_CHARGE:
                return '<img src="/images/icons/error.png" ' . $attr . ' />';
            case self::STAT_FAILED_DEALER:
                return '<img src="/images/icons/user_delete.png" ' . $attr . ' />';
            case self::STAT_FAILED:
                return '<img src="/images/icons/error.png" ' . $attr . ' />';
            case self::STAT_FAILED_MAX_AMOUNT:
                return '<img src="/images/icons/world.png" ' . $attr . ' />';
            case self::STAT_FAILED_MIN_AMOUNT:
                return '<img src="/images/icons/world.png" ' . $attr . ' />';
            case self::STAT_CORRECTION:
                return '<img src="/images/icons/adjustment.png" ' . $attr . ' />';
            case self::STAT_CORRECTION_SUCCESS:
                return '<img src="/images/icons/adjustment_green.png" ' . $attr . ' />';
            case self::STAT_CORRECTION_FAILED:
                return '<img src="/images/icons/adjustment_red.png" ' . $attr . ' />';
            default :
                return '#';
        }
    }

    /**
     * 
     * @param array $trans
     * @return BankKhaan|null
     */
    public static function insert($trans)
    {
        $bankOrder = new BankKhaan();
        $bankOrder->order_id = $trans['JournalNo'];
        $bankOrder->order_id_date = $trans['TxnDate'];
        $bankOrder->bank_account = $trans['Account'];
        $bankOrder->related_account = $trans['relatedAccount'];
        $bankOrder->order_p = $trans['TxnDesc'];
        $bankOrder->order_type = $trans['TxnType'];
        $bankOrder->order_amount = $trans['Amount'];
        $bankOrder->order_date = $trans['TxnDate'];
        $bankOrder->order_s = $trans['Branch'];
        $bankOrder->status = self::STAT_NEW;
        $bankOrder->vendor_id = VendorTable::BANK_KHAAN;
        $bankOrder->created_at = date('Y-m-d H:i:s');

        # mobile bankaar shiljuulsen dugaariig hasah
        $txnDesc = preg_replace("/\([0-9]{8}\)/", "", $trans['TxnDesc']);
        # ATM-iin dugaariig hasah
        $txnDesc = preg_replace("/TRF=[0-9]{12}/", "", $txnDesc);

        //preg_match_all("/[9][954][0-9]{6}/", $txnDesc, $matches);
        preg_match_all("/([9][954][0-9]{6})|(85[0-9]{6})/", $txnDesc, $matches);
        foreach ($matches as $numberArr) {
            foreach ($numberArr as $number) {
                $number = trim($number);
                if ($number) {
                    $bankOrder->order_mobile = $number;
                    $bankOrder->charge_mobile = $number;
                    continue;
                }
            }
        }
        /*
          foreach ($matches as $numberArr) {
          foreach ($numberArr as $number) {
          $number = trim($number);
          if ($number) {
          $bankOrder->order_mobile = $number;
          $bankOrder->charge_mobile = $number;
          continue;
          }
          }
          }
         */
        $bankOrder->save();
        return $bankOrder;
    }

    /**
     * Хуулга татах хаан
     * 
     * @return boolean
     */
    public static function oldInit()
    {
        $getSuccess = 0;
        $setSuccess = 0;
        $errorCode = -1;
        $desc = 'None';
        $request = $url = self::KHAAN_URL;
        $transactions = array();
        $response = '-';
        try {

            $context = stream_context_create(array(
                'ssl' => array(
                    // set some SSL/TLS specific options
                    'verify_peer' => false,
                    'verify_peer_name' => false,
                    'allow_self_signed' => true
                )
            ));
            $client = new SoapClient($url, array(
                'trace' => 1,
                'soap_version' => SOAP_1_2,
                'style' => SOAP_DOCUMENT,
                'encoding' => SOAP_ENCODED,
                'cache_wsdl' => WSDL_CACHE_NONE,
                'stream_context' => $context
            ));
            $actionHeader = new SoapHeader('http://www.w3.org/2005/08/addressing', 'Action', 'http://tempuri.org/IService/getTransactionXML');
            $client->__setSoapHeaders($actionHeader);
            $txns = KhaanTransTable::getTransiction();
            $responseSet = $txns;

            $yaml = sfYaml::load(sfConfig::get('sf_config_dir') . '/app_banks.yml');
            $khaanPassToDec = $yaml['all']['bankKhaanPass'];
            $khaanPass = AppTools::passDecrypt($khaanPassToDec);
            $khaanUserId = $yaml['all']['bankKhaanUserId'];

            $obj = $client->getTransactionXML(array("inst_no" => $khaanUserId, "securecode" => $khaanPass, "txns" => $txns));
            $request = print_r($obj, true);
            $arr = self::object_to_array($obj);
            $errorCode = 0;
            $getSuccess = 1;
            $response = '';
            $mobicomDeallerTransXml = $arr['getTransactionXMLResult'];

            $xml = simplexml_load_string($mobicomDeallerTransXml);
            $xmlArr = json_decode(json_encode((array) $xml), 1);
            $transactions = $xmlArr['txn'];
        } catch (SoapFault $e) {
            $desc = $e->faultstring;
            $responseSet = print_r($obj, true);
        }



        if (count($transactions)) {
            $response = print_r($transactions, true);
            // –залруулга гүйлгээ
            $subTrans = array();
            if (!isset($transactions[0])) {
                $temp[0] = $transactions;
                $transactions = $temp;
            }

            foreach ($transactions as $trans) {
                $param = array();
                $param['TxnType'] = $trans['type'];
                $param['Account'] = $trans['acct'];
           
                $param['JournalNo'] = $trans['jrnl'];
                $param['TxnDesc'] = AppTools::cp1251_utf8($trans['desc']);
                $param['Amount'] = (double) $trans['amt'];
                $param['Branch'] = $trans['branch'];
                $param['TxnDate'] = date('Y-m-d H:i:s', strtotime($trans['date']));

                try {
                    $bankOrder = BankKhaanTable::findOneByOrderId(trim($param['JournalNo']));
                    if (!$bankOrder) {
                        $bankOrder = BankKhaanTable::insert($param);
                    } else {
                        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/my-khaan-order.log'));
                        $logger->log('--DUPLICATED--=' . trim($param['JournalNo']), sfFileLogger::INFO);
                    }
                    // залруулга гүйлгээ 
                    if ($trans['type'] === 'SUB') {
                        $result = BankKhaanTable::updateTransByCorrection($bankOrder['order_mobile'], $param['Amount'], $param['Account']);
                        if ($result) {
                            $bankOrder->setStatus(self::STAT_CORRECTION_SUCCESS);
                        } else {
                            $bankOrder->setStatus(self::STAT_CORRECTION_FAILED);
                        }
                        $bankOrder->save();
                    }
                    // татсан тэмдэглэгээ хийх
                    $transIds[] = trim($param['JournalNo']);
                } catch (\Exception $exc) {
                    $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/my-khaan-order.log'));
                    $logger->log('--ERROR--=' . trim($param['JournalNo']), sfFileLogger::INFO);
                }
            }

            if (count($transIds)) {
                KhaanTransTable::insert($bankOrder['id'], $transIds);
            }
        }

        LogTools::setLogKhaanInit($request, $response, $responseSet, $errorCode, $desc, $getSuccess, $setSuccess);

        unset($response);
        unset($responseSet);
        unset($trans);

        return TRUE;
    }

    /**
     * Хуулга татах хаан
     *
     * @return void
     */
    public static function init()
    {
        $transactions = KhaanCorpgw::getTransactions();
        if (count($transactions)) {
            if (!isset($transactions[0])) {
                $temp[0] = $transactions;
                $transactions = $temp;
            }

            foreach ($transactions as $trans) {
                $param = array();
                if ($trans->amount < 0 || $trans->correction == 1) {
                    $param['TxnType'] = 'SUB';
                } else {
                    $param['TxnType'] = 'ADD';
                }
                $param['Account'] = "0000000" . substr($trans->account, 0, 9);
                $param['relatedAccount'] = $trans->relatedAccount;
                $param['JournalNo'] = $trans->record . $trans->account . $trans->journal;
                $param['TxnDesc'] = htmlspecialchars(AppTools::cp1251_utf8($trans->description), ENT_QUOTES);
                $param['Amount'] = abs((double) $trans->amount);
                $param['Branch'] = $trans->branch;
                if ($trans->time != '0') {
                    $param['TxnDate'] = date('Y-m-d H:i:s',
                            strtotime($trans->tranDate . ' '
                            . substr($trans->time, 0,2) . ':'
                                    . substr($trans->time, 2, 2) . ':'
                                    . substr($trans->time, 4, 2)));
                } else {
                    $param['TxnDate'] = date('Y-m-d H:i:s',
                            strtotime($trans->tranDate . ' 00:00:00'));
                }

                try {
                    $bankOrder = BankKhaanTable::findOneByOrderId(trim($param['JournalNo']));
                    if (!$bankOrder) {
                        $bankOrder = BankKhaanTable::insert($param);
                    } else {
                        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/my-khaan-order.log'));
                        $logger->log('--DUPLICATED--=' . trim($param['JournalNo']), sfFileLogger::INFO);
                    }
                    // залруулга гүйлгээ
                    if ($trans->amount < 0 || $trans->correction == 1) {
                        $result = BankKhaanTable::updateTransByCorrection($bankOrder['order_mobile'], abs($trans->amount), $param['Account']);
                        if ($result) {
                            $bankOrder->setStatus(self::STAT_CORRECTION_SUCCESS);
                        } else {
                            $bankOrder->setStatus(self::STAT_CORRECTION_FAILED);
                        }
                        $bankOrder->save();
                    }

                    $pdo = Doctrine_Manager::connection()->getDbh();
                    $sql = "UPDATE bankgw.bank_khaan_record
                              SET record = '" . $trans->record . "'
                              WHERE account = '" . $trans->account . "'
                              LIMIT 1";
                    $pdo->exec($sql);
                } catch (\Exception $exc) {
                   print_r("error");
                    $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/my-khaan-order.log'));
                    $logger->log('--ERROR--=' . trim($param['JournalNo']), sfFileLogger::INFO);
                    die();
                }
            }
        }
    }

    public static function initByDate($accountList)
    {
        $transactions = KhaanCorpgw::getTransactionsByDate($accountList);
        if (count($transactions)) {
            if (!isset($transactions[0])) {
                $temp[0] = $transactions;
                $transactions = $temp;
            }
            foreach ($transactions as $trans) {
                $param = array();
                if ($trans->amount < 0) {
                    $param['TxnType'] = 'SUB';
                } else {
                    $param['TxnType'] = 'ADD';
                }
                $param['Account'] = "0000000" . substr($trans->account, 0, 9);
                $param['relatedAccount'] = $trans->relatedAccount;
                $param['JournalNo'] = $trans->record . $trans->account . $trans->journal;
                $param['TxnDesc'] = AppTools::cp1251_utf8($trans->description);
                $param['Amount'] = abs((double) $trans->amount);
                $param['Branch'] = $trans->branch;
                if ($trans->time != '0') {
                    $param['TxnDate'] = date('Y-m-d H:i:s',
                            strtotime($trans->tranDate . ' '
                            . substr($trans->time, 0,2) . ':'
                                    . substr($trans->time, 2, 2) . ':'
                                    . substr($trans->time, 4, 2)));
                } else {
                    $param['TxnDate'] = date('Y-m-d H:i:s',
                            strtotime($trans->tranDate . ' 00:00:00'));
                }
                try {
                    $bankOrder = BankKhaanTable::insert($param);
                    // залруулга гүйлгээ
                    if ($trans->amount < 0) {
                        $result = BankKhaanTable::updateTransByCorrection($bankOrder['order_mobile'], abs($trans->amount), $param['Account']);
                        if ($result) {
                            $bankOrder->setStatus(self::STAT_CORRECTION_SUCCESS);
                        } else {
                            $bankOrder->setStatus(self::STAT_CORRECTION_FAILED);
                        }
                        $bankOrder->save();
                    }
                } catch (\Exception $exc) {
                }
            }
        }
    }

    // Khaan Banknii corpgw deploy hiih shunu ajiluulah cron function
    public static function recordUpdater() {
        $transactions = KhaanCorpgw::getAccountLatestRecords();
        if (count($transactions)) {
            foreach ($transactions as $trans) {
                try {
                    $pdo = Doctrine_Manager::connection()->getDbh();
                    $sql = "UPDATE bankgw.bank_khaan_record
                              SET record = '" . $trans->record . "'
                              WHERE account = '" . $trans->account . "'
                              LIMIT 1";
                    $pdo->exec($sql);
                } catch (\Exception $ignored) {
                }
            }
        }
    }

    /**
     * Дахин цэнэглэлт
     *
     * @param null $bankOrder
     * @param null $chargeNumber
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     * @throws Exception
     */
    public static function recharge($bankOrder = null, $chargeNumber = null, $limit)
    {
        $customer = FALSE;
        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
                $customer = TRUE;
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_DEALER, BankKhaanAccountTable::ACCOUNT_DEALER_MOBICOM), $limit);
        }

        foreach ($bankOrderRows as $bankOrder) {
            try {
                $SD = $ADshop = FALSE;
                $chargeResult = $adCode = null;
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }
                if ($bankOrder->status == self::STAT_PROCESS) {
                    $bankOrder->try_count++;
                    $dealer = false;
                    # Dealer AGENT check
                    $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/dealer/process-' . date("Ymd") . '.log'));
                    $dealerAgent = DealerGateway::findDealerByMobile($bankOrder->charge_mobile, $logger);
//                    print_r($dealerAgent);die();
                    if (!$dealerAgent) {
                        $dealer = DealerCharge::getDealer($bankOrder->charge_mobile);
                        $transactionValue = $bankOrder->order_p;
                        if ($chargeNumber) {
                            $transactionValue = $chargeNumber;
                        }
                        $SD = BaseSms::isSdDealer($transactionValue);
                        $ADshop = BaseSms::isAdShop($transactionValue);
                        $adCode = $ADshop;
                        $chainDealer = BaseSms::isChainDealer($transactionValue);

                        if (!$SD && !$ADshop && !$chainDealer) {
                            # If the charge amount exceeds the max amount limit
                            if ($bankOrder->order_amount > self::MAX_AMOUNT_LIMIT) {
                                $bankOrder->status = self::STAT_FAILED_MAX_AMOUNT;
                                $bankOrder->save();
                                self::notifyOperators($bankOrder);
                                continue;
                            } elseif ($bankOrder->order_amount < self::MIN_AMOUNT_LIMIT) {
                                $bankOrder->status = self::STAT_FAILED_MIN_AMOUNT;
                                $bankOrder->save();
                                self::notifyOperators($bankOrder);
                                continue;
                            }
                        }
                    }

                    if ($dealerAgent || $dealer || $adCode || $chainDealer) {
                        $logId = LogTools::setLogKhaanCharge($bankOrder->id);
                        $orderMobile = null;
                        unset($chargeResult);
                        $time = -time();
                        # Цэнэглэлт хийх
                        if ($SD) {
                            $chargeResult = BaseSms::chargeSdDealer($bankOrder->charge_mobile, $bankOrder->order_amount, 'KHAAN');
                        } elseif ($ADshop) {
                            $chargeResult = BaseSms::chargeAdDealer($adCode, $bankOrder->order_amount, 'KHAAN');
                        } elseif ($dealerAgent) {
                            $chargeResult = DealerGateway::charge($dealerAgent['dealerId'], $bankOrder->order_amount, 'KHAAN', $logger);
                            $orderMobile = $dealerAgent['dealerCode'];
                        } elseif ($chainDealer) {
                            $chargeResult = NTCGateway::charge($bankOrder->vendor_id, $bankOrder->order_id, date("Y-m-d"), 'KHAAN', $bankOrder->order_amount, $transactionValue, $bankOrder->id);
                        } else {
                            $chargeResult = DealerCharge::charge($bankOrder->charge_mobile, $bankOrder->order_amount);
                        }
                        $time += time();

                        LogTools::updateLogKhaanCharge($logId, $chargeResult['log_request'], $chargeResult['log_response'], $time);

                        if ($chargeResult['success'] == TRUE) {
                            # Цэнэглэгдсэн мөнгөн дүн болон хувийг хадгалах
                            $bankOrder->charge_amount = $chargeResult['transferred'];
                            $bankOrder->percent = $chargeResult['percent'];
                            if ($orderMobile) {
                                $bankOrder->order_mobile = $orderMobile;
                            }
                            $bankOrder->save();
                            if ($customer) {
                                if ($ADshop) {
                                    TransactionTable::setRechargeAssignment(PaymentTypeTable::DEALER_AD, BankTable::KHAAN, $bankOrder->bank_account, $bankOrder->order_id, $bankOrder->order_date, $bankOrder->order_p, $bankOrder->order_type, $bankOrder->order_amount, $bankOrder->order_s);
                                } else {
                                    TransactionTable::setRechargeAssignment(PaymentTypeTable::DEALER, BankTable::KHAAN, $bankOrder->bank_account, $bankOrder->order_id, $bankOrder->order_date, $bankOrder->order_p, $bankOrder->order_type, $bankOrder->order_amount, $bankOrder->order_s);
                                }
                            } else {
                                try {
                                    if ($ADshop) {
                                        TransactionTable::setDealerAssignment(PaymentTypeTable::DEALER_AD, BankTable::KHAAN, $bankOrder->bank_account, $bankOrder->order_id, $bankOrder->order_date, $bankOrder->order_p, $bankOrder->order_type, $bankOrder->order_amount, $bankOrder->order_s);
                                    } else {
                                        TransactionTable::setDealerAssignment(PaymentTypeTable::DEALER, BankTable::KHAAN, $bankOrder->bank_account, $bankOrder->order_id, $bankOrder->order_date, $bankOrder->order_p, $bankOrder->order_type, $bankOrder->order_amount, $bankOrder->order_s);
                                    }
                                } catch (\Exception $e) {

                                }
                            }
                            if ($SD || $ADshop || $chainDealer) {
                                $bankOrder->status = self::STAT_SUCCESS;
                                $bankOrder->save();
                            } else {
                                # Зарлага үүсгэх
                                $outcomeOrderId = self::reoutcome($bankOrder, $dealer, null, $dealerAgent, $chargeResult['percent']);
                                if ($outcomeOrderId) {
                                    $bankOrder->status = self::STAT_SUCCESS;
                                    $bankOrder->sales_order_id = $outcomeOrderId;
                                    $bankOrder->save();
                                    continue;
                                } else {
                                    $bankOrder->status = self::STAT_FAILED_OUTCOME;
                                    $bankOrder->save();
                                    self::notifyOperators($bankOrder);
                                    continue;
                                }
                            }
                        } else {
                            if ($chargeResult['error_code'] == self::STAT_FAILED_MAX_AMOUNT) {
                                $bankOrder->status = self::STAT_FAILED_MAX_AMOUNT;
                            } elseif ($chargeResult['error_code'] == self::STAT_FAILED_MIN_AMOUNT) {
                                $bankOrder->status = self::STAT_FAILED_MIN_AMOUNT;
                            } else {
                                $bankOrder->status = self::STAT_FAILED_CHARGE;
                            }
                            $bankOrder->save();
                            self::notifyOperators($bankOrder);
                            continue;
                        }
                    } else {
                        $bankOrder->status = self::STAT_FAILED_DEALER;
                        $bankOrder->save();
                        self::notifyOperators($bankOrder);
                        continue;
                    }
                } else {
                    if ($bankOrder->canReCharge() && $bankOrder->try_count < self::MAX_TRY_COUNT) {
                        $bankOrder->status = self::STAT_NEW;
                        $bankOrder->save();
                    }
                    //used to log here...
                }
            } catch (\Exception $ex) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
            }
        }

        return TRUE;
    }

    /**
     * Дахин цэнэглэлт AD shop,SD
     *
     * @param $bankOrder
     * @param $type
     * @return boolean
     * @throws Doctrine_Manager_Exception
     */
    public static function rechargeSMSApi($bankOrder, $type)
    {
        if ($bankOrder instanceof BankKhaan) {
            if (!$bankOrder->canReCharge()) {
                return FALSE;
            }
        } else {
            return FALSE;
        }
        $chargeResult = null;
        $pdo = Doctrine_Manager::connection()->getDbh();
        $sql = "UPDATE bankgw.bank_khaan
              SET status = '" . self::STAT_PROCESS . "'
              WHERE id = '" . $bankOrder['id'] . "'
              LIMIT 1";
        $affectedRows = $pdo->exec($sql);
        if ($affectedRows == 0) {
            return FALSE;
        }
        $bankOrder->status = self::STAT_PROCESS;
        $bankOrder->try_count++;

        # Цэнэглэлт хийх
        $logId = LogTools::setLogKhaanCharge($bankOrder->id);
        $time = -time();
        if ($type == "SD") {
            $chargeResult = BaseSms::chargeSdDealer(str_replace("SD", "", $bankOrder->charge_mobile), $bankOrder->order_amount, 'KHAAN');
        } elseif ($type == "AD") {
            $chargeResult = BaseSms::chargeAdDealer($bankOrder->charge_mobile, $bankOrder->order_amount, 'KHAAN');
        }
        $time += time();
        LogTools::updateLogKhaanCharge($logId, $chargeResult['log_request'], $chargeResult['log_response'], $time);

        if ($chargeResult['success'] == TRUE) {
            if ($type == "AD") {
                TransactionTable::setRechargeAssignment(PaymentTypeTable::DEALER_AD, BankTable::KHAAN, $bankOrder->bank_account, $bankOrder->order_id, $bankOrder->order_date, $bankOrder->order_p, $bankOrder->order_type, $bankOrder->order_amount, $bankOrder->order_s);
            } else {
                TransactionTable::setRechargeAssignment(PaymentTypeTable::DEALER, BankTable::KHAAN, $bankOrder->bank_account, $bankOrder->order_id, $bankOrder->order_date, $bankOrder->order_p, $bankOrder->order_type, $bankOrder->order_amount, $bankOrder->order_s);
            }
            # Цэнэглэгдсэн мөнгөн дүн хадгалах
            $bankOrder->charge_amount = $bankOrder->order_amount;
            $bankOrder->status = self::STAT_SUCCESS;
            $bankOrder->save();
            return TRUE;
        } else {
            if ($chargeResult['error_code'] == self::STAT_FAILED_MAX_AMOUNT) {
                $bankOrder->status = self::STAT_FAILED_MAX_AMOUNT;
            } elseif ($chargeResult['error_code'] == self::STAT_FAILED_MIN_AMOUNT) {
                $bankOrder->status = self::STAT_FAILED_MIN_AMOUNT;
            } else {
                $bankOrder->status = self::STAT_FAILED_CHARGE;
            }
            $bankOrder->save();
        }
        return false;
    }

    public static function notifyOperators($bankOrder)
    {
//        $mailer = sfContext::getInstance()->getMailer();
//
//        $from = 's.alarm@ntc.mn';
//        $to = array('altantulga@mobicom.mn');
//        $subject = '[Dealer alarm] ' . $bankOrder->order_id;
//        $body = 'Сайн байна уу?<br><br>
//                Шалтгаан: <b>' . self::getStatusName($bankOrder->status, BankKhaanTable::TYPE_DEALER) . '</b><br><br>
//                Дараах цэнэглэлт амжилтгүй боллоо:<br>
//                Гүйлгээний дугаар: <b>' . $bankOrder->order_id . '</b><br>
//                Дансны дугаар: <b>' . $bankOrder->bank_account . '</b><br>
//                Цэнэглэх дугаар: <b>' . $bankOrder->charge_mobile . '</b><br>
//                Тушаасан дүн: <b>' . $bankOrder->charge_amount . '</b><br>
//                Хуулганы огноо: <b>' . $bankOrder->order_date . '</b><br>';
//
//        $message = Swift_Message::newInstance()
//                ->setPriority(1)
//                ->setFrom($from, 'Dealer Alarm')
//                ->setSubject($subject)
//                ->setBody($body, 'text/html')
//                ->setTo($to);
//        try {
//            $res = $mailer->send($message);
//        } catch (Swift_TransportException $e) {
//            echo $e->getMessage();
//        }
//        LogTools::setLogEmail($subject, $body, $from, $to);
    }

    /**
     * Дахин зарлага хийх /борлуулалтын бүртгэл/
     *
     * @param BankKhaan $bankOrder
     * @param array $dealer (code => string, alias => string, mobile => int, user_id => int, sale_percent_mtopup => int)
     * @param date $date
     * @param null $dealerAgent
     * @param int $percent
     * @return boolean
     */
    public static function reoutcome($bankOrder, $dealer, $date = null, $dealerAgent = null, $percent = 0)
    {
        if (!($bankOrder instanceof BankKhaan)) {
            return FALSE;
        } elseif ($bankOrder->status == self::STAT_SUCCESS) {
            return FALSE;
        }

        if (!sizeof($dealer) && !sizeof($dealerAgent)) {
            return FALSE;
        }

        if (!$percent) {
            $percent = $bankOrder->percent;
        }
        if ($dealerAgent) {
            $outcomeUserId = BaseSms::DEALER_SYSTEM;
            $dealerCode = $dealerAgent['dealerCode'];
            $dealerAlias = $dealerAgent['locationDesc'];
            $dealerMobile = $bankOrder->charge_mobile;
        } else {
            $outcomeUserId = $dealer['user_id'];
            $dealerCode = $dealer['code'];
            $dealerMobile = $dealer['mobile'];
            $dealerAlias = $dealer['alias'];
        }

        $params = array(
            'vendor' => VendorTable::BANK_KHAAN,
            'outcomeDate' => $date,
            'percent' => $percent,
            'productPrice' => 1,
            'totalPrice' => $bankOrder->order_amount,
            'paid' => $bankOrder->order_amount,
            'customerName' => $dealerCode . ' ' . $dealerAlias,
            'customerPhone' => $dealerMobile,
            'outcomeUserId' => $outcomeUserId,
            'quantity' => $bankOrder->charge_amount,
            'vaucher' => $bankOrder->order_id,
            'comment' => $bankOrder->order_p,
            'discount' => $bankOrder->percent,
            'relationId' => $bankOrder->id,
        );
        LogTools::setSmsOutcomeParam(print_r($params, TRUE));
        return BaseSms::insertOutcomeAPI($params);
    }

    /**
     * Цэнэглэх хуулгууд
     * @param $account
     * @param int $limit
     * @param bool $date
     * @return Doctrine_Collection
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function updateForCharge($account, $limit = 50, $date = false)
    {
        $whichLog = '';
        if($account == array(BankKhaanAccountTable::ACCOUNT_PRODUCT_PAYMENT, BankKhaanAccountTable::ACCOUNT_PRODUCT_PAYMENT_NEW)){
            $whichLog = '/topupSapc/khaan/topupSapc_'.date('Y-m-d').'.log';
        }else if($account == array(BankKhaanAccountTable::ACCOUNT_MOBINET_PAYMENT, BankKhaanAccountTable::ACCOUNT_CALLPAYMENT)){
            $whichLog = '/bankPaymentLog/khaan/bankPaymentLog_'.date('Y-m-d').'.log';
        }else if($account == array(BankKhaanAccountTable::ACCOUNT_PRODUCT_MOBINET)){
            $whichLog = '/bankPaymentHBB/khaan/bankPaymentHBB_'.date('Y-m-d').'.log';
        }
        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') .$whichLog));
        if (!$date) {
            $date = date('Y-m-d H:i:s', time() - 300);
        }
        $pdo = Doctrine_Manager::connection()->getDbh();
        // FOR UPDATE ажиллахын тулд AUTO COMMIT идэвхгүй байх ёстой
        $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 0);
        $pdo->beginTransaction();
        // Шинэ гүйлгээнүүдийн ID-г авч FOR UPDATE-р түгжинэ
        $ids = Doctrine_Query::create()
                ->select('id')
                ->from('BankKhaan')
                ->whereIn('bank_account', $account)
                ->andWhere('order_type = ?', 'ADD')
                ->andWhere('status = ?', self::STAT_NEW)
                ->andWhere('created_at <= ?', $date)
                ->limit($limit)
                ->forUpdate(true)
                ->execute(array(), Doctrine_Core::HYDRATE_SINGLE_SCALAR);
        $logger->log('=====updateForCharge $ids: ' . print_r($ids, true), sfFileLogger::INFO);
        // Олдсон ID-нуудтай гүйлгээнүүдийн төлвийг PROCESS болгоно
        if ($ids) {
            Doctrine_Query::create()
                    ->update('BankKhaan')
                    ->set('status', self::STAT_PROCESS)
                    ->whereIn('id', $ids)
                    ->execute();
            $pdo->commit();
            $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 1);
            // Төлөв нь шинэчлэгдсэн гүйлгээнүүдээ буцаах
            $qSelect = Doctrine_Query::create()
                    ->from('BankKhaan')
                    ->whereIn('id', $ids)
                    ->orderBy('id ASC');
            $logger->log('=====updateForCharge Query:  '. $qSelect->getSQLQuery(), sfFileLogger::INFO);
            return $qSelect->execute();
        } else {
            $pdo->commit();
            $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 1);
            return null;
        }
    }

    /**
     * Цэнэглэсэн хуулгуудыг TRANSACTION рүү зөөхөд ашиглав
     *
     * @param $pdo
     * @param int $limit
     * @return Doctrine_Collection
     * @throws Doctrine_Query_Exception
     */
    public static function updateForTransactions($pdo, $limit)
    {
        // FOR UPDATE ажиллахын тулд AUTO COMMIT идэвхгүй байх ёстой
        $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 0);
        $pdo->beginTransaction();
        $ids = Doctrine_Query::create()
                ->select('id')
                ->from('BankKhaan')
                ->whereNotIn('status', array(self::STAT_PROCESS))
                ->andWhere('transfer_sap=?', 0)
                ->andWhere("(status=1 AND created_at< ?) OR (status!=1 AND created_at <=?)", array(date('Y-m-d H:i:s', time() - 1000), date('Y-m-d H:i:s', time())))
                ->andWhere('created_at >= ?', date('Y-m-d H:i:s', strtotime("-7 days")))
                ->limit($limit)
                ->forUpdate(true)
                ->execute(array(), Doctrine_Core::HYDRATE_SINGLE_SCALAR);
        if ($ids) {
            Doctrine_Query::create()
                    ->update('BankKhaan')
                    ->set('transfer_sap', self::STAT_PROCESS)
                    ->whereIn('id', $ids)
                    ->execute();
            $pdo->commit();
            $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 1);
            $qSelect = Doctrine_Query::create()
                    ->from('BankKhaan')
                    ->whereIn('id', $ids)
                    ->orderBy('order_id_date,created_at');
            return $qSelect->execute();
        } else {
            $pdo->commit();
            $pdo->setAttribute(PDO::ATTR_AUTOCOMMIT, 1);
            return null;
        }
    }

    /**
     * 
     * @param int $mobile
     * @return mixed
     */
    public static function getDealer($mobile)
    {
        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/dealers.log'));

        $link = mysql_connect('database', 'ntcgw', 'B4H3sAWyDvsjC382');
        if ($link === FALSE) {
            $logger->log('[ERROR] ' . mysql_error(), sfFileLogger::INFO);
            return FALSE;
        }

        if (mysql_select_db('dealer', $link) == FALSE) {
            $logger->log('[ERROR] ' . mysql_error(), sfFileLogger::INFO);
            return FALSE;
        }

        mysql_query('SET NAMES utf8', $link);

        $sql = "SELECT user_id, mobile, sale_percent_mtopup, code, alias
                        FROM dealer
                        WHERE mobile = '" . (int) $mobile . "' AND is_active = 1
                        LIMIT 1";
        $result = mysql_query($sql, $link);

        if ($result == FALSE) {
            $logger->log('[ERROR] ' . mysql_error(), sfFileLogger::INFO);
            return FALSE;
        }

        $dealer = mysql_fetch_assoc($result);

        mysql_close($link);

        return $dealer;
    }

    /**
     * Төлөлт оруулах
     *
     * @param null $bankOrder
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function callPayment($bankOrder = null, $limit = 50)
    {
        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_CALLPAYMENT), $limit);
        }

        foreach ($bankOrderRows as $bankOrder) {
            try {
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }
                if ($bankOrder->status == self::STAT_PROCESS) {
                    $bankOrder->try_count++;

                    $logId = LogTools::setLogKhaanChargeCallPayment($bankOrder->id);

                    $time = -time();
                    # төлөлт оруулах
                    $params = array(
                        'transDate' => date('Y-m-d', strtotime($bankOrder['order_date'])),
                        'amount' => $bankOrder['order_amount'],
                        'transValue' => $bankOrder['order_p'],
                        'transAccount' => $bankOrder['bank_account'],
                        'relatedAccount' => $bankOrder['related_account'],
                        'transType' => $bankOrder['order_type'],
                        'transNumber' => $bankOrder['order_id'],
                        'bankType' => VendorTable::BANK_KHAAN,
                    );
                    $chargeResult = CallPayment::charge($params);
                    $time += time();

                    LogTools::updateLogKhaanChargeCallPayment($logId, $chargeResult['log_request'], $chargeResult['log_response'], $time);

                    if ($chargeResult['success'] == TRUE) {
                        # Цэнэглэгдсэн мөнгөн дүн болон хувийг хадгалах
                        $bankOrder->charge_amount = $bankOrder->order_amount;
                        $bankOrder->status = self::STAT_SUCCESS;
                        $bankOrder->save();
                    } else {
                        $bankOrder->status = self::STAT_FAILED_CHARGE;
                        $bankOrder->save();
                        continue;
                    }
                } else {
                    if ($bankOrder->canReCharge() && $bankOrder->try_count < self::MAX_TRY_COUNT) {
                        $bankOrder->status = self::STAT_NEW;
                        $bankOrder->save();
                    }
                    //used to log here...
                }
            } catch (\Exception $ex) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
            }
        }

        return TRUE;
    }

    /**
     *
     * /**
     * Checks if a dealer has charged with exact same amount on a same day.
     * @param $dealerNumber
     * @param $amount
     * @param $date
     * @return Doctrine_Collection
     * @throws Doctrine_Query_Exception
     */
    public static function isDuplicatedToday($dealerNumber, $amount, $date)
    {
        return Doctrine_Query::create()
                        ->from('BankKhaan')
                        ->where('charge_mobile = ?', $dealerNumber)
                        ->andWhere('charge_amount = ?', $amount)
                        ->andWhere('order_date = ?', $date)
                        ->andWhereIn('status', array(self::STAT_SUCCESS))
                        ->execute();
    }

    public static function object_to_array($data)
    {

        if ((!is_array($data)) and ( !is_object($data)))
            return 'xxx'; //$data;       

        $result = array();

        $data = (array) $data;

        foreach ($data as $key => $value) {

            if (is_object($value))
                $value = (array) $value;

            if (is_array($value))
                $result[$key] = self::object_to_array($value);
            else
                $result[$key] = $value;
        }

        return $result;
    }

    /**
     * Checks if a dealer has charged with exact same amount on a same day.
     * @param int $limit
     * @return void
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function setAssignment($limit)
    {
        $pdo = Doctrine_Manager::connection()->getDbh();
        $transactions = self::updateForTransactions($pdo, $limit);
        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/transaction/khaan/transfer_'.date('Y-m-d').'.log'));
        $ids = array();
        foreach ($transactions as $transaction) {

            if ($transaction->status == self::STAT_SUCCESS) {
                # odoogoor zuvkhun dealer charge deer l sales uusgej abigaa uchir shalgav
                if ($transaction->sales_order_id) {
                    $dealerChargeType = PaymentTypeTable::DEALER;
                } elseif (BaseSms::isSdDealer($transaction->order_p)) {
                    $dealerChargeType = PaymentTypeTable::DEALER_SD;
                } elseif (BaseSms::isAdShop($transaction->order_p)) {
                    $dealerChargeType = PaymentTypeTable::DEALER_AD;
                } else {
                    $dealerChargeType = 0;
                }
            } else {
                $dealerChargeType = 0;
            }
            $orderType = $transaction->order_type;
            if ($transaction->order_type === 'DEB') {
                $orderType = 'SUB';
            }

            # assignment 
            try {
                $ids[] = $transaction->id;
                $result = TransactionTable::setDealerAssignment($dealerChargeType, BankTable::KHAAN, $transaction->bank_account, $transaction->order_id, $transaction->order_date, $transaction->order_p, $orderType, $transaction->order_amount, $transaction->order_s);
                $logger->log('KHAAN' . $transaction->order_id, sfFileLogger::INFO);
            } catch (\Exception $exc) {
                $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/dealerTransaction.log'));
                $logger->log($transaction->order_id . 'KHAAN' . $exc->getMessage(), sfFileLogger::ERR);
            }
        }
//        # transwered
        if (count($ids)) {
            try {
                $sql = "UPDATE bankgw.bank_khaan
              SET transfer_sap = 1
              WHERE id IN(" . implode(',', $ids) . ")
              ";
                $pdo->exec($sql);
            } catch (\Exception $exc) {
                $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/dealerTransaction.log'));
                $logger->log('KHAAN-UPDATE' . $exc->getMessage(), sfFileLogger::ERR);
            }
        }
    }

    /**
     * Гүйлгээний утгаас гэрээний дугаарыг олж,
     * Биллийн мэдээллийг татаж bankpayment table -д оруулах
     * CX рүү оруулах төлөлтүүд
     * @param Object $bankOrder
     * @param Boolean $redirectCall (Postpaid tulult bish bol Prepaid shiljuuleh)
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function bankPayment($bankOrder = null, $redirectCall = null, $limit = 50)
    {
        $bankPaymentLogger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/bankPaymentLog/khaan/bankPaymentLog_'.date('Y-m-d').'.log'));
        $bankPaymentLogger->log('============Started bankPayment Khaan================', sfFileLogger::INFO);
        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_MOBINET_PAYMENT, BankKhaanAccountTable::ACCOUNT_CALLPAYMENT), $limit);
        }
        $bankPaymentLogger->log('Total count: ' . count($bankOrderRows), sfFileLogger::INFO);
        echo 'bankPayment count: '.count($bankOrderRows).'</br>';
        $count = 0;
        if(count($bankOrderRows)>0){
        foreach ($bankOrderRows as $bankOrder) {
            try {
                $count++;
                $bill = $phoneNumber = $contractNumber = $contractName = $statusComment = null;
                $contractAmount = $billCycle = $paymentCode = 0;
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }

                $numbers = array();
                $matches = array();
                $bankPaymentLogger->log($bankOrder->order_id . ' count: '.$count, sfFileLogger::INFO);
                $bankPaymentLogger->log('Order Id: '.$bankOrder->order_id . ', Guilgeenii utga: ' . $bankOrder->order_p, sfFileLogger::INFO);
                # mobile bankaar shiljuulsen dugaariig avch hayah
                $txnDesc = preg_replace("/\([0-9]{8}\)/", "", $bankOrder->order_p);
                # Утасны дугаар, гэрээний дугаараас урт тоог хасах
                $txnDesc = preg_replace("/[0-9]{9,}/", "", $txnDesc);
                //preg_match_all("/[0-9]+/", $txnDesc, $matches);
                preg_match_all("/([9][954][0-9]{6})|(85[0-9]{6})|(591[0-9]{5})|([7][75][0-9]{6})|(633[0-9]{5})|([12346][0-9]{7})/", $txnDesc, $matches);
                foreach ($matches as $numberArr) {
                    foreach ($numberArr as $number) {
                        $numbers[] = trim($number);
                    }
                    break;
                }
                if ($bankOrder->getBankAccount() == BankKhaanAccountTable::ACCOUNT_CALLPAYMENT) {
                    $type = BankpaymentTable::TYPE_CALL_PAYMENT;
                    $limit = sfConfig::get('app_bankpayment_gsm_limit');
                } elseif (in_array($bankOrder->getBankAccount(), array(BankKhaanAccountTable::ACCOUNT_MOBINET_PAYMENT, BankKhaanAccountTable::ACCOUNT_PRODUCT_MOBINET))) {
                    $type = BankpaymentTable::TYPE_MOBINET;
                    $limit = sfConfig::get('app_bankpayment_nsl_limit');
                } else {
                    continue;
                }
                $contractNumbers = $phoneNumbers = array();
                foreach ($numbers as $number) {
                    $number = trim($number);
                    if ($number) {
                        if (AppTools::isContractNumber($number)) {
                            if (AppTools::isNumberVoo($number)) {
                                $phoneNumbers[] = $number;
                            }else{
                                $contractNumbers[] = $number;
                            }
                        }
                        
                        if ($type == BankpaymentTable::TYPE_CALL_PAYMENT) {
                            if (AppTools::isNumber($number) || AppTools::isMobinetHHB($number)) {
                                $phoneNumbers[] = $number;
                            }
                        } else if (AppTools::isNumberMobinet($number)) {
                            $phoneNumbers[] = $number;
                            break;
                        }
                    }
                }
                $phoneNumbers = array_unique($phoneNumbers);
                $contractNumbers = array_unique($contractNumbers);
                # guilgeenii utgaas gereenii dugaar,utasnii dugaar oldoogui bol mobile banknii dugaar shalgah
                if ($type == BankpaymentTable::TYPE_CALL_PAYMENT && count($contractNumbers) == 0 && count($phoneNumbers) == 0) {
                    preg_match("/\([0-9]{8}\)/", $bankOrder->order_p, $matches);
                    foreach ($matches as $numberArr) {
                        if (AppTools::isNumber(trim($numberArr, '()'))) {
                            $phoneNumbers[] = trim($numberArr, '()');
                        }
                        break;
                    }
                }
                $insertBankpayment = false;
                if (count($contractNumbers) == 1 || count($phoneNumbers) == 1) {
                    $phoneNumber = isset($phoneNumbers[0]) ? $phoneNumbers[0] : 0;
                    $contractNumber = isset($contractNumbers[0]) ? $contractNumbers[0] : 0;
                    if ($phoneNumber) {
                        $bankPaymentLogger->log($bankOrder->order_id .', PhoneNumber: ' . $phoneNumber, sfFileLogger::INFO);
                        $bill = PostGateway::getBillInfo($phoneNumber);
                        // VOO dugaar bol billInfo gereegeer duudah
                        if(AppTools::isNumberVoo($phoneNumber)){
                            $phoneInfo = PostGateway::getPostPhoneInfo($phoneNumber); 
                            $bankPaymentLogger->log($bankOrder->order_id . ' PostGateway::getPostPhoneInfo:$result: '. print_r($phoneInfo, true), sfFileLogger::INFO);
                            $contractNumber = $phoneInfo['AccountNo'];
                            $bill = PostGateway::getBillInfo(0, $contractNumber);
                            $bankPaymentLogger->log($bankOrder->order_id . ' VOO $contractNumber: '. $contractNumber, sfFileLogger::INFO);
                        } 
                    } else if ($contractNumber) {
                        $bankPaymentLogger->log($bankOrder->order_id .', ContractNumber: ' . $contractNumber, sfFileLogger::INFO);
                        $bill = PostGateway::getBillInfo(0, $contractNumber);
                    }
                    $bankPaymentLogger->log($bankOrder->order_id .' $bill: ' . print_r($bill, true), sfFileLogger::INFO);
                    if ($bill) {
                        // Bill avch Postpaid hereglegch esehiig shalgah
                        if ($bill['Code'] === "0") {
                            $bankPaymentLogger->log($bankOrder->order_id .' Postpaid number matches.', sfFileLogger::INFO);
                            if ($contractNumber && $phoneNumbers && $bill['AccountNo'] !== $contractNumber) {
                                $statusComment = "Гэрээний дугаар зөрүүтэй";
                                $phoneNumber = $contractNumber = '';
                                $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                            } else {
                                $contractNumber = $bill['AccountNo'];
                                $billCycle = $bill['BillCycleCode'];
                                $contractAmount = doubleval($bill['CurrentBalance']);
                                $accountInfo = PostGateway::getAccountInfo($contractNumber);
                                $contractName = $accountInfo['AccountName'];
                                if (floatval(strval($contractAmount - $limit)) <= floatval(strval($bankOrder->order_amount)) &&
                                        floatval(strval($bankOrder->order_amount)) <= floatval(strval($contractAmount + $limit))) {
                                    $status = BankpaymentTable::STAT_NEW;
                                } else {
                                    $status = BankpaymentTable::STAT_BANKPAYMENT_AMOUNT;
                                }
                            }
                        } else {
                            // Postpaid bish bol PhoneInfo duudah
                            $bankPaymentLogger->log($bankOrder->order_id .' Not postpaid number.', sfFileLogger::INFO);
                            $phoneInfo = PostGateway::getPostPhoneInfo($phoneNumber);
                            $bankPaymentLogger->log($bankOrder->order_id .' $phoneInfo: ' . print_r($phoneInfo, true), sfFileLogger::INFO);
                            $yml = sfYaml::load(sfConfig::get('sf_config_dir') . '/app_rtcgw_packages.yml');
                            $prepaidRegex = $yml['all']['regex']['prepaid'];

                            if ($phoneInfo && $phoneInfo['Code'] === "0") {
                                $bankPaymentLogger->log($bankOrder->order_id .' PhoneInfo successful.', sfFileLogger::INFO);
                                preg_match($prepaidRegex, $phoneInfo['TariffCode'], $matches);
                                // Prepaid bol
                                if ($matches) {
                                    $bankPaymentLogger->log($bankOrder->order_id .' Prepaid number matches.', sfFileLogger::INFO);
                                    $card = '';
                                    $optOne = $yml['all']['opt_one'];
                                    $optTwo = $yml['all']['opt_two'];
                                    $type = BankpaymentTable::TYPE_TOPUP;
                                    $result = '';
                                    if (array_key_exists(strval($bankOrder->order_amount), $optOne)) {
                                        $card = $optOne[$bankOrder->order_amount];
                                        $result = RtcgwGateway::chargeTopup($phoneNumber, $card, "bankgw_khan1");
                                        $bankPaymentLogger->log($bankOrder->order_id .' OptOne matches: '. $card, sfFileLogger::INFO);
                                    } elseif (array_key_exists(strval($bankOrder->order_amount), $optTwo)) {
                                        $card = $optTwo[$bankOrder->order_amount];
                                        $result = RtcgwGateway::chargeTopup($phoneNumber, $card, "bankgw_khan1");
                                        $bankPaymentLogger->log($bankOrder->order_id .' OptTwo matches: '. $card, sfFileLogger::INFO);
                                    } elseif ($bankOrder->order_amount < 15000) {
                                        if (floor($bankOrder->order_amount) == $bankOrder->order_amount) {
                                            $result = SmallUnitGateway::chargeUnit($phoneNumber, $bankOrder->order_amount, 'bankgw_khaan', "khan1");
                                            $bankPaymentLogger->log($bankOrder->order_id . ' 15000-s baga duntei negjiin tseneglelt: '.$bankOrder->order_amount, sfFileLogger::INFO);
                                        }
                                    }
                                    if (isset($result) && isset($result['Code']) && $result['Code'] == 0) {
                                        $status = BankpaymentTable::STAT_SUCCESS;
                                        try {
                                            TransactionTable::setAssignmentMain(PaymentTypeTable::AUTO_PREPAID, BankTable::getBankAndVendorMap($bankOrder['vendor_id']), $bankOrder['bank_account'], $bankOrder['order_id'], $bankOrder['order_date'], $bankOrder['order_p'], $bankOrder['order_type'], $bankOrder['order_amount'], $bankOrder['order_s'], "BANKPAYMENT", false, 0);
                                        } catch (Exception $ex) {
                                            $bankPaymentLogger->log('setAssignmentMain error: '. $ex, sfFileLogger::ERR);
                                            try {
                                                TransactionTable::setAssignmentMain(PaymentTypeTable::AUTO_PREPAID, BankTable::getBankAndVendorMap($bankOrder['vendor_id']), $bankOrder['bank_account'], $bankOrder['order_id'], $bankOrder['order_date'], $bankOrder['order_p'], $bankOrder['order_type'], $bankOrder['order_amount'], $bankOrder['order_s'], "BANKPAYMENT", false, 0);
                                            } catch (Exception $ex) {
                                                $bankPaymentLogger->log('retry setAssignmentMain error: '. $ex, sfFileLogger::ERR);
                                            }
                                        }
                                    } else {
                                        $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                                        $status = BankpaymentTable::STAT_FAILED_CHARGE;
                                    }
                                    $bankPaymentLogger->log($bankOrder->order_id . ' $result: ' . print_r($result, true), sfFileLogger::INFO);
                                    $bankPaymentLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                                    self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                                    if($status == BankpaymentTable::STAT_SUCCESS && $type == BankpaymentTable::TYPE_TOPUP){
                                        // Send VAT
                                        self::sendPaymentVat($bankOrder);
                                    }
                                    continue;
                                } else {
                                    $statusComment = $bill['Info'];
                                    $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                                    $bankPaymentLogger->log($bankOrder->order_id . ' Not Prepaid number $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                                }
                            } else {
                                $statusComment = $bill['Info'];
                                $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                                $bankPaymentLogger->log($bankOrder->order_id . ', PhoneInfo not received or not active number, $code: '.$phoneInfo['Code'].' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                            }
                        }
                    } elseif ($contractNumber) {
                        $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                        $bankPaymentLogger->log($bankOrder->order_id . 'Bill not received, $contractNumber: '.$contractNumber. '$status: '.$status .' $contractNumber: ' . $contractNumber, sfFileLogger::INFO);
                    } else {
                        $statusComment = "Bill info not ";
                        $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                        $bankPaymentLogger->log($bankOrder->order_id . ' $status: '.$status .' $statusComment: ' . $statusComment, sfFileLogger::INFO);
                    }
                } elseif (count($contractNumbers) == 0 && count($phoneNumbers) == 0) {
                    $statusComment = "Гүйлгээний утга буруу";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    // Олон дугаартай үед нэг гэрээний дугаартай эсэхийг шалгах
                } elseif (count($phoneNumbers) > 1) {
                    $bankPaymentLogger->log($bankOrder->order_id . ' Олон дугаартай үед нэг гэрээний дугаартай эсэхийг шалгах ', sfFileLogger::INFO);
                    $success = 1;
                    $accountNos = array();
                    foreach ($phoneNumbers as $phoneNumber) {
                        $bill = PostGateway::getBillInfo($phoneNumber);
                        if ($bill) {
                            if ($bill['Code'] === "0") {
                                $accountNos[] = $bill['AccountNo'];
                                $billCycle = $bill['BillCycleCode'];
                                $contractAmount = doubleval($bill['CurrentBalance']);
                            } else {
                                $success = 0;
                            }
                        } else {
                            $success = 0;
                        }
                    }
                    if ($success) {
                        $contractNumbers = array_unique($accountNos);
                        if (count($contractNumbers) > 1) {
                            $statusComment = "Олон дугаартай";
                            $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                            $contractAmount = 0;
                            $contractName = '-';
                        } else {
                            $contractNumber = $contractNumbers[0];
                            $accountInfo = PostGateway::getAccountInfo($contractNumber);
                            $contractName = $accountInfo['AccountName'];
                            if (floatval(strval($contractAmount - $limit)) <= floatval(strval($bankOrder->order_amount)) &&
                                    floatval(strval($bankOrder->order_amount)) <= floatval(strval($contractAmount + $limit))) {
                                $status = BankpaymentTable::STAT_NEW;
                            } else {
                                $status = BankpaymentTable::STAT_BANKPAYMENT_AMOUNT;
                            }
                            $phoneNumber = $phoneNumbers[0];
                        }
                    } else {
                        $statusComment = "Олон дугаартай";
                        $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    }
                } else {
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                }
                # Hereglegch oldohgui bol HBB shalgah
                if (!in_array($status, array(BankpaymentTable::STAT_NEW, BankpaymentTable::STAT_BANKPAYMENT_AMOUNT))) {
                    if ($redirectCall) {
                        return false;
                    } else {
                        # Guilgeenii utgaas medeelel oldoogui bol HBB Prepaid tulult shalgah
                        $insertBankpayment = self::bankPaymentHBB($bankOrder, TRUE);
                    }
                }

                $bankPaymentLogger->log($bankOrder->order_id . ' $status: ' . $status.' $statusComment: ' . $statusComment, sfFileLogger::INFO);
                # burtgeegui bol burtgeh
                if (!$insertBankpayment) {
                    $bankPaymentLogger->log($bankOrder->order_id . ' burtgeh', sfFileLogger::INFO);
                    self::insertPostpaidBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $contractNumber, $contractName, $billCycle, $contractAmount);
                }
            } catch (\Exception $ex) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
                $bankPaymentLogger->log('Error: '.$bankOrder->order_id .' Error message: '.$ex, sfFileLogger::ERR);
            }
        }
        }
        $bankPaymentLogger->log('=============== Ended bankPayment Khaan===============', sfFileLogger::INFO);
        return TRUE;
    }

    /**
     * Улуснэтийн төлөлтийн дансны гүйлгээнүүдийг
     *  bankpayment table -д оруулах
     * @param object bank
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function bankPaymentUlusnet($bankOrder = null, $limit = 50)
    {
        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_PRODUCT_ULUSNET), $limit);
        }

        foreach ($bankOrderRows as $bankOrder) {
            try {
                $contractNumber = $contractName = null;
                $contractAmount = $billCycle = $paymentCode = 0;
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }
                $phoneNumber = BankpaymentTable::findPhoneNumber($bankOrder->order_p, BankpaymentTable::TYPE_ULUSNET);
                $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                if ($phoneNumber) {
                    $accountInfo = PostGateway::getPostPhoneInfo($phoneNumber);
                    if ($accountInfo && $accountInfo['Code'] === "0") {
                        $contractNumber = $accountInfo['AccountNo'];
                        $contractName = $accountInfo['AccountName'];
                        $status = BankpaymentTable::STAT_NEW;
                    }
                }

                $data = array();
                $data['vendor_id'] = VendorTable::BANK_KHAAN;
                $data['bank_order_id'] = $bankOrder->id;
                $data['type'] = BankpaymentTable::TYPE_ULUSNET;
                $data['status'] = $status;
                $data['number'] = $phoneNumber;
                $data['contract_number'] = $contractNumber;
                $data['contract_name'] = $contractName;
                $data['bill_cycle'] = $billCycle;
                $data['contract_amount'] = $contractAmount;
                $data['credit_control'] = 123;

                BankpaymentTable::insert($data);
                $bankOrder->status = self::STAT_SUCCESS;
                $bankOrder->save();
                unset($bankOrder);
            } catch (\Exception $ex) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
            }
        }

        return TRUE;
    }

    /**
     * Мобинэт HBB prepaid төлөлтийн дансны гүйлгээнүүдийг
     *  дамжуулах
     * @param null $bankOrder
     * @param Boolean $redirectCall (Prepaid tulult bish bol Postruu shiljuuleh)
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function bankPaymentHBB($bankOrder = null, $redirectCall = null, $limit = 50)
    {
        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/bankPaymentHBB/khaan/bankPaymentHBB_'.date('Y-m-d').'.log'));
        $logger->log('============Started bankPaymentHBB Khaan================', sfFileLogger::INFO);

        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_PRODUCT_MOBINET), $limit);
        }
        $logger->log('Total count: ' . count($bankOrderRows), sfFileLogger::INFO);
        $count = 0;
        echo 'bankPaymentHBB count =>'.count($bankOrderRows).'</br>';
        if(count($bankOrderRows)>0){
        foreach ($bankOrderRows as $bankOrder) {
            try {
                $count++;
                $contractNumber = $contractName = null;
                $contractAmount = $billCycle = $paymentCode = 0;
                $username = $contractName = '';
                
                $logger->log($bankOrder->order_id . ' count: '.$count, sfFileLogger::INFO);
                $logger->log('Order Id: '.$bankOrder->order_id . ', Guilgeenii utga: ' . $bankOrder->order_p, sfFileLogger::INFO);
                $logger->log($bankOrder->order_id . ' status: ' . $bankOrder->status, sfFileLogger::INFO);
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }
                $logger->log($bankOrder->order_id . ' status1: ' . $bankOrder->status, sfFileLogger::INFO);
                $insertBankpayment = false;
                # MOBINET WIGI shalgah
                $wifiRegex = "/WIFI-(([9][954][0-9]{6})|(85[0-9]{6}))-([0-9_a-zA-Z]{1,20})-*/";
                if (preg_match($wifiRegex, $bankOrder->order_p, $matches)) {
                    $logger->log('--WIFI--=', sfFileLogger::INFO);
                    $type = BankpaymentTable::TYPE_WIFI;
                    $phoneNumber = $matches[1];
                    $card = $matches[4];
                    $username = $phoneNumber;
                    # TEST hiih dugaaruudiig l zuvshuuruv
                    //if (in_array($phoneNumber, array('94300074', '94300115'))) {
                    $result = WifiOnlineGateway::chargeCard($phoneNumber, $card, "bankgw_khaan");
                    //}
                    if (isset($result['Code']) && $result['Code'] == 0) {
                        $status = BankpaymentTable::STAT_SUCCESS;
                    } else {
                        $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                        $status = BankpaymentTable::STAT_FAILED_CHARGE;
                    }
                } elseif (self::bankPaymentVOO($bankOrder)) {
                    $logger->log('--VOO--=', sfFileLogger::INFO);
                    //herevee VOO giin tulult bol algasay
                    continue;
                } else {
                    $keyword = BankpaymentTable::findHbbContract($bankOrder->order_p);
                    if (!$keyword) {
                        $keyword = BankpaymentTable::findHbbUsername($bankOrder->order_p);
                    }
                    $logger->log($bankOrder->order_id . ' $keyword: ' . $keyword , sfFileLogger::INFO);

                    $type = BankpaymentTable::TYPE_MOBINET_PREPAID;
                    $speed = 0;
                    if ($keyword) {
                        $accountInfo = MobinetGateway::contractInfo($keyword);
                        $logger->log($bankOrder->order_id . ' $accountInfo:' . print_r($accountInfo, true), sfFileLogger::INFO);

                        if (isset($accountInfo['id']) && $accountInfo['id']) {
                            if (AppTools::isPostHbbContract($accountInfo['contract'])) {
                                $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                                #haigaad oldson geree, username-iig shalgah
                            } else {
                                $contractNumber = $accountInfo['contract'];
                                $username = $accountInfo['username'];
                                $speed = $accountInfo['speed'];
                                $contractName = $accountInfo['lastname'] . ' ' . $accountInfo['firstname'];
                                $status = BankpaymentTable::STAT_NEW;
                                unset($accountInfo);
                            }
                        } else {
                            $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                        }
                    } else {
                        $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    }
                }
                $logger->log($bankOrder->order_id . ' status2:' . $status, sfFileLogger::INFO);
                if ($status == BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE) {

                }
                # Hereglegch oldohgui bol HBB shalgah
                if ($status !== BankpaymentTable::STAT_NEW) {
                    $logger->log($bankOrder->order_id . ' status3:' . $status, sfFileLogger::INFO);
                    if ($redirectCall) {
                        return false;
                    } else {
                        # Guilgeenii utgaas medeelel oldoogui bol Postpaid tulult shalgah
                        $insertBankpayment = self::bankPayment($bankOrder, TRUE);
                    }
                }
                $logger->log($bankOrder->order_id . ' status4:' . $status, sfFileLogger::INFO);

                if (!$insertBankpayment) {
                    $logger->log($bankOrder->order_id . ' status5:' . $status, sfFileLogger::INFO);
                    try {
                        $data = array();
                        $data['vendor_id'] = VendorTable::BANK_KHAAN;
                        $data['bank_order_id'] = $bankOrder->id;
                        $data['type'] = $type;
                        $data['status'] = $status;
                        $data['number'] = $username;
                        $data['contract_number'] = $contractNumber;
                        $data['contract_name'] = $contractName;
                        $data['contract_amount'] = $contractAmount;

                        $bankpayment = BankpaymentTable::insert($data);
                        if ($bankpayment && $type = BankpaymentTable::TYPE_MOBINET_PREPAID) {
                            BankpaymentMobinetTable::insert($bankpayment->id, $speed);
                        }
                        $bankOrder->status = self::STAT_SUCCESS;
                        $bankOrder->save();
                    } catch (Exception $exc) {
                        $logger->log('$insertHBBBankpayment Khaan Error: '.$bankOrder->order_id .' Error message: '.$exc, sfFileLogger::ERR);
                    }
                }

                unset($bankOrder);
            } catch (\Exception $ex) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
                $logger->log($bankOrder->order_id . ' Error: ' . $ex, sfFileLogger::INFO);
            }
        }
        }
        $logger->log('============Ended bankPaymentHBB Khaan================', sfFileLogger::INFO);
        return TRUE;
    }
    
    /**
     * Гүйлгээний утгаас VOO дугаарыг олж,
     * Биллийн мэдээллийг татаж bankpayment table -д оруулах
     * CX рүү оруулах төлөлтүүд
     * @param Object $bankOrder
     * @param Boolean $redirectCall (Postpaid tulult bish bol Prepaid shiljuuleh)
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function bankPaymentVOO($bankOrder = null, $redirectCall = null, $limit = 50)
    {
        if (!($bankOrder instanceof BankKhaan)) {
            return FALSE;
        }
        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/bankPaymentHBB/khaan/bankPaymentHBB_'.date('Y-m-d').'.log'));
        try {
            $bill = $phoneNumber = $contractNumber = $contractName = $statusComment = null;
            $contractAmount = $billCycle = $paymentCode = 0;
            $numbers = array();
            $matches = array();
            $logger->log($bankOrder->order_id . ' order_p' . $bankOrder->order_p, sfFileLogger::INFO);
            # mobile bankaar shiljuulsen dugaariig avch hayah
            $txnDesc = preg_replace("/\([0-9]{8}\)/", "", $bankOrder->order_p);
            # Утасны дугаар, гэрээний дугаараас урт тоог хасах
            $txnDesc = preg_replace("/[0-9]{9,}/", "", $txnDesc);
            //preg_match_all("/[0-9]+/", $txnDesc, $matches);
            preg_match_all("/(491[0-9]{5})/", $txnDesc, $matches);
            foreach ($matches as $numberArr) {
                foreach ($numberArr as $number) {
                    $numbers[] = trim($number);
                }
                break;
            }
            if ($bankOrder->getBankAccount() == BankKhaanAccountTable::ACCOUNT_CALLPAYMENT) {
                $type = BankpaymentTable::TYPE_CALL_PAYMENT;
                $limit = sfConfig::get('app_bankpayment_gsm_limit');
            } elseif (in_array($bankOrder->getBankAccount(), array(BankKhaanAccountTable::ACCOUNT_MOBINET_PAYMENT, BankKhaanAccountTable::ACCOUNT_PRODUCT_MOBINET))) {
                $type = BankpaymentTable::TYPE_MOBINET;
                $limit = sfConfig::get('app_bankpayment_nsl_limit');
            } else {
                continue;
            }
            
            $phoneNumbers = array_unique($numbers);
            $logger->log($bankOrder->order_id . ' $phoneNumbers: ' . print_r($phoneNumbers, true), sfFileLogger::INFO);

            $insertBankpayment = false;
            if (count($phoneNumbers) == 1) {
                $phoneNumber = isset($phoneNumbers[0]) ? $phoneNumbers[0] : 0;
                if (!AppTools::isNumberVoo($phoneNumber)) {
                    return false;
                }
                $insertBankpayment = true;
                if ($phoneNumber) {
                    $bill = PostGateway::getBillInfo($phoneNumber);
                }
                $logger->log($bankOrder->order_id . ' $phoneNumber: ' . $phoneNumber, sfFileLogger::INFO);
                $logger->log($bankOrder->order_id . ' $bill: ' . print_r($bill, true), sfFileLogger::INFO);
                if ($bill) {
                    if ($bill['Code'] === "0") {
                        $contractNumber = $bill['AccountNo'];
                        $billCycle = $bill['BillCycleCode'];
                        $contractAmount = doubleval($bill['CurrentBalance']);
                        $accountInfo = PostGateway::getAccountInfo($contractNumber);
                        $contractName = $accountInfo['AccountName'];
                        if (floatval(strval($contractAmount - $limit)) <= floatval(strval($bankOrder->order_amount)) &&
                                floatval(strval($bankOrder->order_amount)) <= floatval(strval($contractAmount + $limit))) {
                            $status = BankpaymentTable::STAT_NEW;
                        } else {
                            $status = BankpaymentTable::STAT_BANKPAYMENT_AMOUNT;
                        }
                    } else {
                        $statusComment = $bill['Info'];
                        $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                    }
                } else {
                    $statusComment = "Bill info not ";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                }
                $logger->log($bankOrder->order_id . ' $status: ' . $status. ' $statusComment: ' . $statusComment, sfFileLogger::INFO);
            } else {
                return false;
            }
            # burtgeegui bol burtgeh
            if ($insertBankpayment) {
                $logger->log($bankOrder->order_id . ' burtgeh', sfFileLogger::INFO);
                $data = array();
                $data['vendor_id'] = VendorTable::BANK_KHAAN;
                $data['bank_order_id'] = $bankOrder->id;
                $data['type'] = $type;
                $data['status'] = $status;
                $data['status_comment'] = $statusComment;
                $data['number'] = $phoneNumber;
                $data['contract_number'] = $contractNumber;
                $data['contract_name'] = $contractName;
                $data['bill_cycle'] = $billCycle;
                $data['contract_amount'] = $contractAmount;
                $data['credit_control'] = 123;
                BankpaymentTable::insert($data);
                $bankOrder->status = BankpaymentTable::STAT_SUCCESS;
                $bankOrder->save();
                unset($bankOrder);
                return true;
            }
        } catch (\Exception $ex) {
            $logger->log($bankOrder->order_id . ' Error: '. $ex->getMessage(), sfFileLogger::INFO);
            return false;
        }
        return false;
    }
    
    /**
     * Guilgeend Vat uusgej mail esvel msg-eer yavuulah,
     * @param Object $bankOrder
     * @param int $type
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function sendPaymentVat($bankOrder)
    {
        if (!($bankOrder instanceof BankKhaan)) {
            return FALSE;
        }
        try {
            $bill = $phoneNumber = $contractNumber = $contractName = $statusComment = null;
            $contractAmount = $billCycle = $paymentCode = 0;
            $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/PaymentVAT/khaan/PaymentVAT_'.date('Y-m-d').'.log'));
            $logger->log($bankOrder->order_id . ' PaymentVAT:KHAAN VAT', sfFileLogger::INFO);
            
            $bankpayment = BankpaymentTable::retrieveByBankOrderId($bankOrder->id, $bankOrder->vendor_id);
            $bankTransaction = BankpaymentTable::getBankTransaction($bankOrder->vendor_id, $bankOrder->id);
            $logger->log($bankOrder->order_id . 'bankpayment: ' . $bankpayment->id, sfFileLogger::INFO);
            $logger->log($bankOrder->order_id . '$bankTransaction: ' . $bankTransaction->id, sfFileLogger::INFO);
            if ($bankTransaction) {
                $bankAccount = $bankTransaction->getBankAccount();
                $bankTopup = BankAccountTable::getByAccount($bankAccount);
                $paymentCode = $bankTopup->getBankCode();                    
                $bankName = VendorTable::getNameById($bankpayment['vendor_id']);
                
                $isdn = $bankpayment['number'];
                $amount = ($bankpayment['parent_id'] == 0) ? $bankTransaction['order_amount'] : $bankpayment['paid_amount'];
                $phoneInfo = PostGateway::getPostPhoneInfo($phoneNumber);
                $contract = $phoneInfo['AccountNo'] ? $phoneInfo['AccountNo'] : $bankpayment['contract_number'];
                $productCode = null;
                $productName = null;
                $company = null;
                if(in_array($bankpayment['type'], array(BankpaymentTable::TYPE_TOPUP, BankpaymentTable::TYPE_SAPC))){
                    $productCode = PaymentTypeTable::AUTO_PREPAID;
                    $productName = BaseSms::getTopupProductName($bankpayment['vendor_id'],$bankpayment['contract_number'], $bankpayment['type']);
                    $company = 'mobicom';
                    $logger->log('--createAndSendVat--=', sfFileLogger::INFO);
                    $result = BasicVatSenderNew::createAndSendVat($isdn, $contract, $amount, $bankAccount, $paymentCode, $bankName, $productName, $productCode, null, $company);
                    $logger->log($bankOrder->order_id . ' SEND_VAT_RESPONSE: ' . print_r($result, true), sfFileLogger::INFO);
                    if (isset($result['errorCode']) && isset($result['errorCode']) == 0) {
                        return true;
                    } else{
                        return false;
                    }
                }
                return false;
            } else {
                return false;
            }
        } catch (\Exception $ex) {
            $logger->log($bankOrder->order_id . 'sendPaymentVat ERROR: ' . $ex, sfFileLogger::INFO);
            return false;
        }
        return false;
    }

    /**
     * Гүйлгээний утгаас утасны дугаар Картын сонголтыг таниж цэнэглэлт хийх
     * Биллийн мэдээллийг татаж bankpayment table -д оруулах
     *
     * @param null $bankOrder
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function bankPaymentTopupSapc($bankOrder = null, $limit = 50)
    {
        $topupLogger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/topupSapc/khaan/topupSapc_'.date('Y-m-d').'.log'));
        $topupLogger->log('============Started bankPaymentTopupSapc Khaan================', sfFileLogger::INFO);
        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_PRODUCT_PAYMENT, BankKhaanAccountTable::ACCOUNT_PRODUCT_PAYMENT_NEW), $limit, date('Y-m-d H:i:s'));
        }
        $topupLogger->log('Total count: ' . count($bankOrderRows), sfFileLogger::INFO);
        echo 'bankPaymentTopupSapcCount----'.count($bankOrderRows).'</br>';
        $count = 0;
        if(count($bankOrderRows)>0){
        foreach ($bankOrderRows as $bankOrder) {
            try {
                $count++;
                $phoneNumber = $contractNumber = $card = $statusComment = null;
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }
                
                $topupLogger->log($bankOrder->order_id . ' count: '.$count, sfFileLogger::INFO);
                $topupLogger->log('Order Id: '.$bankOrder->order_id . ', Guilgeenii utga: ' . $bankOrder->order_p, sfFileLogger::INFO);
                $matches = array();
                $txnDesc = $bankOrder->order_p;
                $topupRegex = "/PRETOP-(([9][954][0-9]{6})|(85[0-9]{6}))-([0-9_a-z]{2,20})-*/";
                $sapcRegex = "/SAPC-(([9][954][0-9]{6})|(85[0-9]{6}))-([0-9_.a-zA-Z]{2,20})-*/";
                if (preg_match($topupRegex, $txnDesc, $matches)) {
                    $topupLogger->log('--PRETOP--=', sfFileLogger::INFO);
                    $type = BankpaymentTable::TYPE_TOPUP;
                    $phoneNumber = $matches[1];
                    $card = $matches[4];
                    # TEST hiih dugaaruudiig l zuvshuuruv
                    //if (in_array($phoneNumber, array('94300074', '94300115'))) {
                  $result = RtcgwGateway::chargeTopup($phoneNumber, $card, "bankgw_khan2");
                 
                    //}
                    if (isset($result['Code']) && $result['Code'] == 0) {
                        $status = BankpaymentTable::STAT_SUCCESS;
                        self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                        $topupLogger->log($bankOrder->order_id . ' RtcgwGateway::$result: '. print_r($result, true), sfFileLogger::INFO);
                        // Send VAT
                        self::sendPaymentVat($bankOrder);
                        continue;
                    } else {
                        $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                        $status = BankpaymentTable::STAT_FAILED_CHARGE;
                        $topupLogger->log($bankOrder->order_id . ' RtcgwGateway::$result: '. $statusComment, sfFileLogger::INFO);
                    }
                } elseif (preg_match($sapcRegex, $txnDesc, $matches)) {
                    $topupLogger->log('--SAPC--=', sfFileLogger::INFO);
                    $type = BankpaymentTable::TYPE_SAPC;
                    $phoneNumber = $matches[1];
                    $card = $matches[4];
                    # TEST hiih dugaaruudiig l zuvshuuruv
                    //if (in_array($phoneNumber, array('94300074', '94300115'))) {
                    $result = SapcGateway::chargeFreePackage($phoneNumber, $card, $logger, "KHANBANK");
                    //}
                    if (isset($result['Code']) && $result['Code'] == 0) {
                        $status = BankpaymentTable::STAT_SUCCESS;
                        self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                        // Send VAT
                        self::sendPaymentVat($bankOrder);
                        $topupLogger->log($bankOrder->order_id . ' SapcGateway::$result: '. print_r($result, true), sfFileLogger::INFO);
                        continue;
                    } else {
                        $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                        $status = BankpaymentTable::STAT_FAILED_CHARGE;
                        $topupLogger->log($bankOrder->order_id . ' SapcGateway::$result: '. $statusComment, sfFileLogger::INFO);
                    }
                }

                $doPostpaidPayment = false;
                $bill = $phoneNumber = $contractNumber = $contractName = $statusComment = null;
                $contractAmount = $billCycle = $paymentCode = 0;
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }

                $numbers = array();
                $matches = array();
                $topupLogger->log($bankOrder->order_id . ' order_p====: ' . $bankOrder->order_p, sfFileLogger::INFO);
                # mobile bankaar shiljuulsen dugaariig avch hayah
                $txnDesc = preg_replace("/\([0-9]{8}\)/", "", $bankOrder->order_p);
                # Утасны дугаар, гэрээний дугаараас урт тоог хасах
                $txnDesc = preg_replace("/[0-9]{9,}/", "", $txnDesc);
                //preg_match_all("/[0-9]+/", $txnDesc, $matches);
                preg_match_all("/([9][954][0-9]{6})|(85[0-9]{6})|(591[0-9]{5})|([7][75][0-9]{6})|(633[0-9]{5})|([12346][0-9]{7})/", $txnDesc, $matches);
                foreach ($matches as $numberArr) {
                    foreach ($numberArr as $number) {
                        $numbers[] = trim($number);
                    }
                    break;
                }

                $limit = sfConfig::get('app_bankpayment_gsm_limit');
                $contractNumbers = $phoneNumbers = array();
                foreach ($numbers as $number) {
                    $number = trim($number);
                    if ($number) {
                        if (AppTools::isContractNumber($number)) {
                            if (AppTools::isNumberVoo($number)) {
                                $phoneNumbers[] = $number;
                            } else{
                                $contractNumbers[] = $number;
                            }
                        }
                        if (AppTools::isNumber($number) || AppTools::isMobinetHHB($number)) {
                            $phoneNumbers[] = $number;
                        }
                    }
                }
                $phoneNumber = isset($phoneNumbers[0]) ? $phoneNumbers[0] : 0;
                $contractNumber = isset($contractNumbers[0]) ? $contractNumbers[0] : 0;
                $topupLogger->log($bankOrder->order_id . ' $phoneNumber: ' . $phoneNumber, sfFileLogger::INFO);
		        $topupLogger->log($bankOrder->order_id . ' $contractNumber: ' . $contractNumber, sfFileLogger::INFO);
                $phoneInfo = PostGateway::getPostPhoneInfo($phoneNumber); 
                $topupLogger->log($bankOrder->order_id . ' PostGateway::getPostPhoneInfo:$result: '. print_r($phoneInfo, true), sfFileLogger::INFO);
//                $phoneInfo = 0;
//                if($phoneNumber){
//                    $phoneInfo = PostGateway::getPostPhoneInfo($phoneNumber); 
//                    $topupLogger->log($bankOrder->order_id . ' PostGateway::getPostPhoneInfo:$result: '. print_r($phoneInfo, true), sfFileLogger::INFO);
//                } else{
//		    $topupLogger->log($bankOrder->order_id . '  $phoneInfo: '. $phoneInfo, sfFileLogger::INFO);
//		}
                $yml = sfYaml::load(sfConfig::get('sf_config_dir') . '/app_rtcgw_packages.yml');
                $hybridRegex = $yml['all']['regex']['hybrid'];
                $postpaidRegex = $yml['all']['regex']['postpaid'];
                $prepaidRegex = $yml['all']['regex']['prepaid'];
                if ($phoneInfo && $phoneInfo['Code'] === "0") {
                    $hybridMatches = array();
                    $postpaidMatches = array();
                    $prepaidMatches = array();
                    preg_match($hybridRegex, $phoneInfo['TariffCode'], $hybridMatches);
                    preg_match($postpaidRegex, $phoneInfo['TariffCode'], $postpaidMatches);
                    preg_match($prepaidRegex, $phoneInfo['TariffCode'], $prepaidMatches);
                    $topupLogger->log($bankOrder->order_id . ' TariffCode: '. $phoneInfo['TariffCode'], sfFileLogger::INFO);
                    if ($hybridMatches) {
                        $topupLogger->log('--HYBRID--=', sfFileLogger::INFO);
                        // Hybrid dugaar Opt 2 charge hiih gej uzeed faildsen bol
                        if (isset($status) && $status == BankpaymentTable::STAT_FAILED_CHARGE) {
                            $topupLogger->log($bankOrder->order_id . ' Hybrid dugaar Opt 2 charge hiih gej uzeed faildsen bol', sfFileLogger::INFO);
                            if ($bankOrder->order_amount < 15000) {
                                $topupLogger->log($bankOrder->order_id . ' 15000 doosh duntei', sfFileLogger::INFO);
                                if (floor($bankOrder->order_amount) == $bankOrder->order_amount) {
                                    $type = BankpaymentTable::TYPE_TOPUP;
                                    $result = SmallUnitGateway::chargeUnit($phoneNumber, $bankOrder->order_amount, 'bankgw_khaan', "khan2");
                                    if (isset($result['Code']) && $result['Code'] == 0) {
                                        $status = BankpaymentTable::STAT_SUCCESS;
                                    } else {
                                        $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                                        $status = BankpaymentTable::STAT_FAILED_CHARGE;
                                    }
                                    $topupLogger->log($bankOrder->order_id . ' SmallUnitGateway::chargeUnit:$result: '. print_r($phoneInfo, true), sfFileLogger::INFO);
                                } else {
                                    $statusComment = "Амжилтгүй";
                                    $status = BankpaymentTable::STAT_FAILED_CHARGE;
                                }
                                $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                                self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                                // Send VAT
                                self::sendPaymentVat($bankOrder);
                                continue;
                            } else {
                                $topupLogger->log($bankOrder->order_id . ' $doPostpaidPayment 15000 deesh duntei', sfFileLogger::INFO);
                                $doPostpaidPayment = true;
                            }
                        } elseif (count($phoneNumbers) == 1) {
                            $optOne = $yml['all']['opt_one'];
                            if (array_key_exists(strval($bankOrder->order_amount), $optOne)) {
                                $type = BankpaymentTable::TYPE_TOPUP;
                                $card = $optOne[$bankOrder->order_amount];
                                $result = RtcgwGateway::chargeTopup($phoneNumber, $card, "bankgw_khan2");
                                if (isset($result['Code']) && $result['Code'] == 0) {
                                    $status = BankpaymentTable::STAT_SUCCESS;
                                } else {
                                    $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                                    $status = BankpaymentTable::STAT_FAILED_CHARGE;
                                }

                                $topupLogger->log($bankOrder->order_id . ' $optOne: '.$card . ', $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                                self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                                // Send VAT
                                self::sendPaymentVat($bankOrder);
                                continue;
                            } elseif ($bankOrder->order_amount < 15000) {
                                $topupLogger->log($bankOrder->order_id . ' $bankOrder->order_amount < 15000', sfFileLogger::INFO);
                                $type = BankpaymentTable::TYPE_TOPUP;
                                if (floor($bankOrder->order_amount) == $bankOrder->order_amount) {
                                    $result = SmallUnitGateway::chargeUnit($phoneNumber, $bankOrder->order_amount, 'bankgw_khaan', "khan2");
                                    if (isset($result['Code']) && $result['Code'] == 0) {
                                        $status = BankpaymentTable::STAT_SUCCESS;
                                        // Send VAT
                                        self::sendPaymentVat($bankOrder);
                                    } else {
                                        $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                                        $status = BankpaymentTable::STAT_FAILED_CHARGE;
                                    }
                                } else {
                                    $statusComment = "Амжилтгүй";
                                    $status = BankpaymentTable::STAT_FAILED_CHARGE;
                                }
                                $topupLogger->log($bankOrder->order_id . ' $result: '. print_r($result, true), sfFileLogger::INFO);
                                $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                                self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                                continue;
                            } else {
                                $doPostpaidPayment = true;
                            }
                        } else {
                            $statusComment = "Олон дугаартай";
                            $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                        }
                    } elseif ($postpaidMatches) {
                        $doPostpaidPayment = true;
                    } elseif ($prepaidMatches) {
                        $topupLogger->log('--PREPAID--=', sfFileLogger::INFO);
                        if (count($contractNumbers) == 1 || count($phoneNumbers) == 1) {
                            $card = '';
                            $optOne = $yml['all']['opt_one'];
                            $optTwo = $yml['all']['opt_two'];
                            $type = BankpaymentTable::TYPE_TOPUP;
                            $result = '';
                            if (array_key_exists(strval($bankOrder->order_amount), $optOne)) {
                                $card = $optOne[$bankOrder->order_amount];
                                $result = RtcgwGateway::chargeTopup($phoneNumber, $card, "bankgw_khan2");
                            } elseif (array_key_exists(strval($bankOrder->order_amount), $optTwo)) {
                                $card = $optTwo[$bankOrder->order_amount];
                                $result = RtcgwGateway::chargeTopup($phoneNumber, $card, "bankgw_khan2");
                            }
                            if (isset($result) && isset($result['Code']) && $result['Code'] == 0) {
                                $status = BankpaymentTable::STAT_SUCCESS;
                            } else {
                                $statusComment = "Амжилтгүй(" . $result ['Info'] . ")";
                                $status = BankpaymentTable::STAT_FAILED_CHARGE;
                            }
                            $topupLogger->log($bankOrder->order_id . ' $result: '. print_r($result, true), sfFileLogger::INFO);
                            $topupLogger->log($bankOrder->order_id . ' $card: '.$card .' $status: '.$status . ', $statusComment: '. $statusComment, sfFileLogger::INFO);
                            self::insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card);
                            // Send VAT
                             self::sendPaymentVat($bankOrder);
                            continue;
                        } else {
                            $statusComment = "Олон дугаартай";
                            $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                        }
                    }
                } elseif (count($contractNumbers) > 1 || count($phoneNumbers) > 1) {
                    $statusComment = "Олон дугаартай";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    // Олон дугаартай үед нэг гэрээний дугаартай эсэхийг шалгах
                } else {
                    $bankOrder->status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    $bankOrder->save();
                }

                if ($doPostpaidPayment) {
                    $topupLogger->log('--POSTPAID--=', sfFileLogger::INFO);
                    $type = BankpaymentTable::TYPE_CALL_PAYMENT;
                    if (count($contractNumbers) == 1 || count($phoneNumbers) == 1) {
                        $phoneNumber = isset($phoneNumbers[0]) ? $phoneNumbers[0] : 0;
                        $contractNumber = isset($contractNumbers[0]) ? $contractNumbers[0] : 0;
                        if ($phoneNumber) {
                            $topupLogger->log($bankOrder->order_id . ' $phoneNumber: ' . $phoneNumber, sfFileLogger::INFO);
                            $bill = PostGateway::getBillInfo($phoneNumber);
                            // VOO dugaar bol billInfo gereegeer duudah
                            if(AppTools::isNumberVoo($phoneNumber) && isset($phoneInfo['AccountNo']) && $phoneInfo['AccountNo'] != '' ){
                                $contractNumber = $phoneInfo['AccountNo'];
                                $bill = PostGateway::getBillInfo(0, $contractNumber);
                                $topupLogger->log($bankOrder->order_id . ' VOO $contractNumber: '. $contractNumber, sfFileLogger::INFO);
                            } 
                        } else if ($contractNumber) {
                            $topupLogger->log($bankOrder->order_id . ' $contractNumber: ' . $contractNumber, sfFileLogger::INFO);
                            $bill = PostGateway::getBillInfo(0, $contractNumber);
                        }
                        $topupLogger->log($bankOrder->order_id . ' $bill: ' . print_r($bill, true), sfFileLogger::INFO);
                        if ($bill) {
                            if ($bill['Code'] === "0") {
                                if ($contractNumber && $phoneNumbers && $bill['AccountNo'] !== $contractNumber) {
                                    $statusComment = "Гэрээний дугаар зөрүүтэй";
                                    $phoneNumber = $contractNumber = '';
                                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                                } else {
                                    $contractNumber = $bill['AccountNo'];
                                    $billCycle = $bill['BillCycleCode'];
                                    $contractAmount = doubleval($bill['CurrentBalance']);
                                    $accountInfo = PostGateway::getAccountInfo($contractNumber);
                                    $contractName = $accountInfo['AccountName'];
                                    if (floatval(strval($contractAmount - $limit)) <= floatval(strval($bankOrder->order_amount)) &&
                                            floatval(strval($bankOrder->order_amount)) <= floatval(strval($contractAmount + $limit))) {
                                        $status = BankpaymentTable::STAT_NEW;
                                    } else {
                                        $status = BankpaymentTable::STAT_BANKPAYMENT_AMOUNT;
                                    }
                                }
                                $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                            } else {
                                $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                                $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                            }
                        } elseif ($contractNumber) {
                            $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                        } else {
                            $statusComment = "Bill info not ";
                            $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                            $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                        }
                        $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                    } elseif (count($contractNumbers) == 0 && count($phoneNumbers) == 0) {
                        $statusComment = "Гүйлгээний утга буруу";
                        $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                        // Олон дугаартай үед нэг гэрээний дугаартай эсэхийг шалгах
                    } else {
                        $statusComment = "Олон дугаартай";
                        $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    }
                    $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                } elseif (count($contractNumbers) > 1 || count($phoneNumbers) > 1) {
                    $type = BankpaymentTable::TYPE_TOPUP;
                    $statusComment = "Олон дугаартай";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    // Олон дугаартай үед нэг гэрээний дугаартай эсэхийг шалгах
                } else {
                    $type = BankpaymentTable::TYPE_TOPUP;
                    $statusComment = "Гүйлгээний утга буруу";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                    // Олон дугаартай үед нэг гэрээний дугаартай эсэхийг шалгах
                }
                $topupLogger->log($bankOrder->order_id . ' $status: '.$status . ' $statusComment: '. $statusComment, sfFileLogger::INFO);
                self::insertPostpaidBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $contractNumber, $contractName, $billCycle, $contractAmount);

            } catch (\Exception $exception) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
                $topupLogger->log('Error: '.$bankOrder->order_id .' Error message: '.$exception, sfFileLogger::ERR);
            }
        }
        }
        $topupLogger->log('==========Ended bankPaymentTopupSapc Khaan================', sfFileLogger::INFO);

        return TRUE;
    }

    public static function bankPaymentFromTransaction($bankOrder, $redirectCall = null, $limit = 50)
    {
        $logger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/bankPaymentFromTransaction/khaan/bankPaymentFromTransaction_'.date('Y-m-d').'.log'));
        $logger->log('============Started bankPaymentFromTransaction Khaan================', sfFileLogger::INFO);
        if ($bankOrder instanceof BankKhaan) {
            if ($bankOrder->canReCharge()) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_MOBINET_PAYMENT, BankKhaanAccountTable::ACCOUNT_CALLPAYMENT), $limit);
        }
        $logger->log('Total count: ' . count($bankOrderRows), sfFileLogger::INFO);
        echo 'bankPaymentFromTransaction count: '.count($bankOrderRows).'</br>';
        $count = 0;
        if(count($bankOrderRows)>0){
        foreach ($bankOrderRows as $bankOrder) {
            try {
                $bill = $phoneNumber = $contractNumber = $contractName = $statusComment = null;
                $contractAmount = $billCycle = $paymentCode = 0;
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }
                $logger->log($bankOrder->order_id . ' count: '.$count, sfFileLogger::INFO);
                $logger->log('Order Id: '.$bankOrder->order_id . ', Guilgeenii utga: ' . $bankOrder->order_p, sfFileLogger::INFO);
                $numbers = array();
                $matches = array();
                # mobile bankaar shiljuulsen dugaariig avch hayah
                $txnDesc = preg_replace("/\([0-9]{8}\)/", "", $bankOrder->order_p);
                # Утасны дугаар, гэрээний дугаараас урт тоог хасах
                $txnDesc = preg_replace("/[0-9]{9,}/", "", $txnDesc);
                //preg_match_all("/[0-9]+/", $txnDesc, $matches);
                preg_match_all("/([9][954][0-9]{6})|(85[0-9]{6})|(591[0-9]{5})|([7][75][0-9]{6})|(633[0-9]{5})|([12346][0-9]{7})/", $txnDesc, $matches);
                foreach ($matches as $numberArr) {
                    foreach ($numberArr as $number) {
                        $numbers[] = trim($number);
                    }
                    break;
                }

                $type = BankpaymentTable::TYPE_CALL_PAYMENT;
                if ($bankOrder->getBankAccount() == BankKhaanAccountTable::ACCOUNT_CALLPAYMENT) {
                    $type = BankpaymentTable::TYPE_CALL_PAYMENT;
                    $limit = sfConfig::get('app_bankpayment_gsm_limit');
                } elseif (in_array($bankOrder->getBankAccount(), array(BankKhaanAccountTable::ACCOUNT_MOBINET_PAYMENT, BankKhaanAccountTable::ACCOUNT_PRODUCT_MOBINET))) {
                    $type = BankpaymentTable::TYPE_MOBINET;
                    $limit = sfConfig::get('app_bankpayment_nsl_limit');
                }

                $contractNumbers = $phoneNumbers = array();
                foreach ($numbers as $number) {
                    $number = trim($number);
                    if ($number) {
                        if (AppTools::isContractNumber($number)) {
                            $contractNumbers[] = $number;
                        }
                        if ($type == BankpaymentTable::TYPE_CALL_PAYMENT) {
                            if (AppTools::isNumber($number) || AppTools::isMobinetHHB($number)) {
                                $phoneNumbers[] = $number;
                            }
                        } else if (AppTools::isNumberMobinet($number)) {
                            $phoneNumbers[] = $number;
                            break;
                        }
                    }
                }
                $logger->log($bankOrder->order_id . ' $phoneNumbers', sfFileLogger::INFO);
                $phoneNumbers = array_unique($phoneNumbers);
                $contractNumbers = array_unique($contractNumbers);
                # guilgeenii utgaas gereenii dugaar,utasnii dugaar oldoogui bol mobile banknii dugaar shalgah
                if ($type == BankpaymentTable::TYPE_CALL_PAYMENT && count($contractNumbers) == 0 && count($phoneNumbers) == 0) {
                    preg_match("/\([0-9]{8}\)/", $bankOrder->order_p, $matches);
                    foreach ($matches as $numberArr) {
                        if (AppTools::isNumber(trim($numberArr, '()'))) {
                            $phoneNumbers[] = trim($numberArr, '()');
                        }
                        break;
                    }
                }
                $insertBankpayment = false;
                if (count($contractNumbers) == 1 || count($phoneNumbers) == 1) {
                    $phoneNumber = isset($phoneNumbers[0]) ? $phoneNumbers[0] : 0;
                    $contractNumber = isset($contractNumbers[0]) ? $contractNumbers[0] : 0;
                    if ($phoneNumber) {
                        $logger->log($bankOrder->order_id .', $phoneNumber: ' . $phoneNumber, sfFileLogger::INFO);
                        $bill = PostGateway::getBillInfo($phoneNumber);
                    } else if ($contractNumber) {
                        $bill = PostGateway::getBillInfo(0, $contractNumber);
                        $logger->log($bankOrder->order_id .', $contractNumber: ' . $contractNumber, sfFileLogger::INFO);
                    }
                    $logger->log($bankOrder->order_id . ' $bill' . print_r($bill, true), sfFileLogger::INFO);
                    if ($bill) {
                        if ($bill['Code'] === "0") {
                            $logger->log($bankOrder->order_id .' Postpaid number matches.', sfFileLogger::INFO);
                            if ($contractNumber && $phoneNumbers && $bill['AccountNo'] !== $contractNumber) {
                                $statusComment = "Гэрээний дугаар зөрүүтэй";
                                $phoneNumber = $contractNumber = '';
                                $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                            } else {
                                $contractNumber = $bill['AccountNo'];
                                $billCycle = $bill['BillCycleCode'];
                                $contractAmount = doubleval($bill['CurrentBalance']);
                                $accountInfo = PostGateway::getAccountInfo($contractNumber);
                                $contractName = $accountInfo['AccountName'];
                                if (floatval(strval($contractAmount - $limit)) <= floatval(strval($bankOrder->order_amount)) &&
                                        floatval(strval($bankOrder->order_amount)) <= floatval(strval($contractAmount + $limit))) {
                                    $status = BankpaymentTable::STAT_NEW;
                                } else {
                                    $status = BankpaymentTable::STAT_BANKPAYMENT_AMOUNT;
                                }
                            }
                        } else {
                            $statusComment = $bill['Info'];
                            $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                        }
                    } elseif ($contractNumber) {
                        $status = BankpaymentTable::STAT_FAILED_BILL_INFO;
                    } else {
                        $statusComment = "Bill info not ";
                        $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                        $logger->log($bankOrder->order_id . ' $statusComment' . $statusComment, sfFileLogger::INFO);
                    }
                } elseif (count($contractNumbers) == 0 && count($phoneNumbers) == 0) {
                    $statusComment = "Гүйлгээний утга буруу";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                } else {
                    $statusComment = "Олон дугаартай";
                    $status = BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE;
                }
                # Hereglegch oldohgui bol HBB shalgah
                if (!in_array($status, array(BankpaymentTable::STAT_NEW, BankpaymentTable::STAT_BANKPAYMENT_AMOUNT))) {
                    if ($redirectCall) {
                        return false;
                    } else {
                        # Guilgeenii utgaas medeelel oldoogui bol HBB Prepaid tulult shalgah
                        $insertBankpayment = self::bankPaymentHBB($bankOrder, TRUE);
                    }
                }

                $logger->log($bankOrder->order_id . ' $status: ' . $status.' $statusComment: ' . $statusComment, sfFileLogger::INFO);
                # burtgeegui bol burtgeh
                if (!$insertBankpayment) {
                    $logger->log($bankOrder->order_id . ' burtgeh', sfFileLogger::INFO);
                    self::insertPostpaidBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $contractNumber, $contractName, $billCycle, $contractAmount);
                }
            } catch (\Exception $ex) {
                $bankOrder->status = self::STAT_FAILED;
                $bankOrder->save();
                $logger->log('Error: '.$bankOrder->order_id .' Error message: '.$ex, sfFileLogger::ERR);
            }
        }
        }
        $logger->log('============Ended bankPaymentFromTransaction Khaan================', sfFileLogger::INFO);
        return TRUE;
    }

    /**
     * Candy цэнэглэлт Bankpayment-рүү хийх
     *  дамжуулах
     * @param object bank
     * @param int $limit
     * @return boolean
     * @throws Doctrine_Manager_Exception
     * @throws Doctrine_Query_Exception
     */
    public static function loyaltyBankpayment($bankOrder = null, $limit = 50)
    {
        if ($bankOrder instanceof BankKhaan) {
            if (in_array($bankOrder->status, array(
                        BankKhaanTable::STAT_FAILED,
                        BankKhaanTable::STAT_PROCESS,
                        BankKhaanTable::STAT_FAILED_CHARGE,
                        BankKhaanTable::STAT_FAILED_OUTCOME))) {
                $bankOrder->status = self::STAT_PROCESS;
                $bankOrder->save();
            }
            $bankOrderRows = array($bankOrder);
        } elseif ($bankOrder) {
            return FALSE;
        } else {
            $bankOrderRows = self::updateForCharge(array(BankKhaanAccountTable::ACCOUNT_MOBIFINANCE_CANDY, BankKhaanAccountTable::ACCOUNT_CANDY_CASHIN), $limit);
        }
        foreach ($bankOrderRows as $bankOrder) {
            try {
                if (in_array($bankOrder->status, array(self::STAT_FAILED_CHARGE, self::STAT_FAILED))) {
                    $bankOrder->status = self::STAT_PROCESS;
                    $bankOrder->save();
                }

                $txnDesc = preg_replace("/\([0-9]{8}\)/", "", $bankOrder->order_p);
                $chargeNumber = LoyaltyCharge::findCandyLoan($txnDesc);
                if ($chargeNumber) {
                    $loanAmount = null;
                    $cashInAmount = null;
                    $type = null;
                    $isQpay = LoyaltyCharge::checkCandyQpay($txnDesc);
                    if ($isQpay) {
                        $type = BankpaymentTable::TYPE_CANDY_QPAY;
                        self::insertBankpaymentLoyalty($bankOrder, $type, $chargeNumber, $bankOrder->order_amount);
                        $bankOrder->setStatus(BankKhaanTable::STAT_SUCCESS);
                        $bankOrder->save();
                        continue;
                    }
                    $isCandyAgent = LoyaltyCharge::checkCandyAgent($txnDesc);
                    $isCandyAccount = LoyaltyCharge::checkCandyAccount($bankOrder['bank_account'], 'KHAAN');
                    if ($bankOrder['bank_account'] == BankKhaanAccountTable::ACCOUNT_MOBIFINANCE_CANDY) {
                        $loanCheck = LoyaltyCharge::checkLoan($chargeNumber);
                        if ($loanCheck['Code'] !== 0) {
                            $status = self::STAT_FAILED_CHARGE;
                            $bankOrder->setStatus($status);
                            $bankOrder->save();
                            self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_CASHIN, $chargeNumber, $bankOrder['order_amount'], '', 4);
                            continue;
                        }
                        // Zeeltei bol
                        if ($loanCheck['Result']['items'][0]['total'] > 0) {
                            $cashInAmount = $bankOrder['order_amount'] - $loanCheck['Result']['items'][0]['total'];
                            $loanAmount = $loanCheck['Result']['items'][0]['total'];
                            if ($cashInAmount < 0) {
                                $cashInAmount = null;
                                $loanAmount = $bankOrder['order_amount'];
                            }
                        } else {
                            $cashInAmount = $bankOrder['order_amount'];
                        }
                    } else {
                        $cashInAmount = $bankOrder['order_amount'];
                    }

                    if ($isCandyAgent && $isCandyAccount) {
                        $loyaltyId = LoyaltyCharge::getCandy($isCandyAgent);
                        if ($loyaltyId != 0) {
                            self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_AGENT, $chargeNumber, $bankOrder->order_amount, $loyaltyId);
                        } else {
                            if (!$loanAmount) {
                                self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_CASHIN, $chargeNumber, $cashInAmount);
                            } else {
                                if ($cashInAmount > 0) {
                                    $bankpayment = self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_CASHIN, $chargeNumber, $cashInAmount);
                                    self::copyBankpaymentLoyalty($bankpayment, $loanAmount, BankpaymentTable::TYPE_CANDY_LOAN, $chargeNumber);
                                } else {
                                    self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_LOAN, $chargeNumber, $loanAmount);
                                }
                            }
                        }
                    } else {
                        if (!$loanAmount) {
                            self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_CASHIN, $chargeNumber, $cashInAmount);
                        } else {
                            if ($cashInAmount) {
                                $bankpayment = self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_CASHIN, $chargeNumber, $cashInAmount);
                                self::copyBankpaymentLoyalty($bankpayment, $loanAmount, BankpaymentTable::TYPE_CANDY_LOAN, $chargeNumber);
                            } else {
                                self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_LOAN, $chargeNumber, $loanAmount);
                            }
                        }
                    }
                    $bankOrder->setStatus(BankKhaanTable::STAT_SUCCESS);
                    $bankOrder->save();
                    unset($bankOrder);
                } else {
                    if ($bankOrder['bank_account'] == BankKhaanAccountTable::ACCOUNT_MOBIFINANCE_CANDY) {
                        self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_LOAN, $chargeNumber, $bankOrder['order_amount'], '', BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE);
                    } else {
                        self::insertBankpaymentLoyalty($bankOrder, BankpaymentTable::TYPE_CANDY_CASHIN, $chargeNumber, $bankOrder['order_amount'], '', BankpaymentTable::STAT_BANKPAYMENT_TRANS_VALUE);
                    }
                    $bankOrder->setStatus(self::STAT_FAILED_CHARGE);
                    $bankOrder->save();
                }
            } catch (\Exception $ex) {
                $bankOrder->setStatus(self::STAT_FAILED_CHARGE);
                $bankOrder->save();
            }
        }

        return TRUE;
    }

    public static function insertBankpaymentLoyalty($bankOrder, $type, $chargeNumber, $amount, $loyaltyId = '', $status = 1) {
        $data = array();
        $data['vendor_id'] = VendorTable::BANK_KHAAN;
        $data['bank_order_id'] = $bankOrder->id;
        $data['type'] = $type;
        $data['status'] = $status;
        $data['status_comment'] = '';
        $data['number'] = $chargeNumber;
        $data['contract_number'] = $loyaltyId;
        $data['contract_name'] = '';
        $data['bill_cycle'] = '';
        $data['paid_amount'] = $amount;
        $data['contract_amount'] = '';
        $data['credit_control'] = 123;
        $bankpayment = BankpaymentTable::insert($data);
        return $bankpayment;
    }

    public static function copyBankpaymentLoyalty($bankpayment, $amount, $type, $chargeNumber)
    {
        $childCount = (int) BankpaymentTable::getChildCount($bankpayment['id']);
        $values = array();
        $values['parent_id'] = $bankpayment['id'];
        $values['vendor_id'] = $bankpayment['vendor_id'];
        $values['type'] = $type;
        $values['bank_order_id'] = $bankpayment['bank_order_id'];
        $values['child_num'] = ++$childCount;
        $values['paid_amount'] = $amount;
        $values['status'] = BankpaymentTable::STAT_NEW;
        $values['number'] = $chargeNumber;
        BankpaymentTable::insert($values);
    }

    static function contains($needle, $haystack)
    {
        return strpos($haystack, $needle) !== false;
    }

    /**
     * @param $bankOrder
     * @param $type
     * @param $status
     * @param $statusComment
     * @param $phoneNumber
     * @param $card
     * @throws Exception
     */
    public static function insertTopupBankpayment($bankOrder, $type, $status, $statusComment, $phoneNumber, $card)
    {
        try {
            $data = array();
            $data['vendor_id'] = VendorTable::BANK_KHAAN;
            $data['bank_order_id'] = $bankOrder->id;
            $data['type'] = $type;
            $data['status'] = $status;
            $data['status_comment'] = $statusComment;
            $data['number'] = $phoneNumber;
            $data['contract_amount'] = '0';
            $data['contract_name'] = '-';
            $data['contract_number'] = $card;
            $data['bill_cycle'] = '-';
            $data['credit_control'] = "-";
            BankpaymentTable::insert($data);
            $bankOrder->status = BankpaymentTable::STAT_SUCCESS;
            $bankOrder->save();
            unset($bankOrder);
        } catch (Exception $exc) {
            $topupLogger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/topupSapc/khaan/topupSapc_'.date('Y-m-d').'.log'));
            $topupLogger->log('insertTopupBankpayment Khaan Error: '.$bankOrder->order_id .' Error message: '.$exc, sfFileLogger::ERR);
        }
    }

    /**
     * @param BankKhaan $bankOrder
     * @param $type
     * @param $status
     * @param $statusComment
     * @param $phoneNumber
     * @param $contractNumber
     * @param $contractName
     * @param $billCycle
     * @param $contractAmount
     * @throws Exception
     */
    public static function insertPostpaidBankpayment(BankKhaan $bankOrder, $type, $status, $statusComment, $phoneNumber, $contractNumber, $contractName, $billCycle, $contractAmount)
    {
        try {
            $data = array();
            $data['vendor_id'] = VendorTable::BANK_KHAAN;
            $data['bank_order_id'] = $bankOrder->id;
            $data['type'] = $type;
            $data['status'] = $status;
            $data['status_comment'] = $statusComment;
            $data['number'] = $phoneNumber;
            $data['contract_number'] = $contractNumber;
            $data['contract_name'] = $contractName;
            $data['bill_cycle'] = $billCycle;
            $data['contract_amount'] = $contractAmount;
            $data['credit_control'] = 123;
            BankpaymentTable::insert($data);
            $bankOrder->status = BankpaymentTable::STAT_SUCCESS;
            $bankOrder->save();
            unset($bankOrder);
        } catch (Exception $exc) {
            $bankPaymentLogger = new sfFileLogger(new sfEventDispatcher(), array('file' => sfConfig::get('sf_log_dir') . '/bankPaymentLog/khaan/bankPaymentLog_'.date('Y-m-d').'.log'));
            $bankPaymentLogger->log('insertPostpaidBankpayment Khaan Error: '.$bankOrder->order_id .' Error message: '.$exc->getMessage(), sfFileLogger::ERR);
        }

    }
}
